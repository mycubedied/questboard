<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Quest Board</title>
    <script type="module" src="/main.js"></script>
    <style>
        .quest-board-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .quest-board-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .quest-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .quest-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .quest-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .quest-description {
            color: #666;
            margin-bottom: 10px;
        }

        .quest-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .quest-status.active { background: #4caf50; color: white; }
        .quest-status.pending { background: #ff9800; color: white; }
        .quest-status.completed { background: #2196f3; color: white; }

        .quest-category {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 10px;
            text-transform: uppercase;
        }

        .category-cardio { background: #e3f2fd; color: #1976d2; }
        .category-strength { background: #fce4ec; color: #c2185b; }
        .category-flexibility { background: #f3e5f5; color: #7b1fa2; }
        .category-wellness { background: #e8f5e9; color: #388e3c; }
        .category-custom { background: #eceff1; color: #37474f; }

        .complete-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: background 0.3s;
        }
        .complete-btn:hover { background: #45a049; }
        .complete-btn:disabled { background: #cccccc; cursor: not-allowed; }

        .start-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            margin-left: 10px;
            transition: background 0.3s;
        }
        .start-btn:hover { background: #1976d2; }

        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 8px;
        }
        .delete-btn:hover { background: #d32f2f; }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 20px;
            font-size: 16px;
        }
        .refresh-btn:hover { background: #5568d3; }

        .coin-display {
            background: #ffd700;
            color: #333;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 18px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .shop-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            margin-left: 10px;
        }
        .shop-btn:hover { background: #f57c00; }

        .terms-btn {
            background: #607d8b;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 8px;
            font-size: 14px;
        }
        .terms-btn:hover { background: #546e7a; }

        .shop-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .shop-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .shop-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; border-bottom: 2px solid #667eea; padding-bottom:15px; }
        .shop-close { font-size:32px; font-weight:bold; color:#999; cursor:pointer; transition:color 0.3s; }
        .shop-close:hover { color:#333; }

        .shop-section { margin-bottom: 30px; }
        .shop-section h3 { color: #667eea; margin-bottom: 15px; }
        .shop-items { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }

        .shop-item { background: white; border: 2px solid #ddd; border-radius: 10px; padding: 15px; text-align: center; transition: all 0.3s; cursor: pointer; }
        .shop-item:hover { border-color: #667eea; transform: translateY(-3px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2); }
        .shop-item.owned { border-color: #4caf50; background: #e8f5e9; }
        .shop-item.equipped { border-color: #ffd700; background: #fffde7; }
        .shop-item-emoji { font-size: 48px; margin-bottom: 10px; }
        .shop-item-name { font-weight: bold; margin-bottom: 5px; }
        .shop-item-price { color: #ffd700; font-weight: bold; font-size: 16px; }

        .buy-btn { background: #4caf50; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px; font-weight: bold; }
        .buy-btn:hover { background: #45a049; }
        .buy-btn:disabled { background: #ccc; cursor: not-allowed; }

        .equip-btn { background: #2196f3; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px; font-weight: bold; }
        .equip-btn:hover { background: #1976d2; }

        .profile-avatar { font-size: 48px; margin-right: 10px; }
        .profile-title { color: #667eea; font-weight: bold; margin-left: 10px; }

        .login-container { max-width: 400px; margin: 100px auto; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header h2 { color: #667eea; margin: 0; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; box-sizing: border-box; }
        .form-group input:focus { outline: none; border-color: #667eea; }

        .btn-login { width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-login:hover { opacity: 0.9; }

        .signup-link { text-align: center; margin-top: 20px; color: #666; }
        .signup-link a { color: #667eea; text-decoration: none; font-weight: bold; }
        .signup-link a:hover { text-decoration: underline; }

        .error-message { color: #f44336; font-size: 14px; margin-top: 10px; text-align: center; }

        #main-content { display: none; }

        .quest-controls { display:flex; gap:12px; align-items:center; }
        .quest-filter { padding:8px 12px; border-radius:6px; border:1px solid #ddd; font-size:14px; background:white; }
        .quest-filter:focus { outline:none; border-color:#667eea; }

        .custom-quest-form { margin: 18px 0; padding: 12px; background: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
        .custom-quest-form input[type="text"] { flex:1 1 240px; padding:8px 10px; border-radius:6px; border:1px solid #ddd; font-size:14px; }
        .custom-quest-form textarea { flex:2 1 360px; padding:8px 10px; border-radius:6px; border:1px solid #ddd; font-size:14px; resize:vertical; min-height:48px; }
        .add-custom-btn { background: #00bfa5; color: white; border: none; padding: 10px 16px; border-radius:6px; cursor:pointer; font-weight:bold; }
        .add-custom-btn:hover { background: #009e90; }

        .streak-info { display:flex; flex-direction:column; align-items:flex-end; gap:6px; }
        .streak-badge { background: linear-gradient(90deg,#ff7043,#ffca28); color: white; padding:6px 12px; border-radius:999px; font-weight:bold; font-size:14px; display:inline-flex; align-items:center; }
        .streak-help { font-size:12px; color:#444; opacity:0.85; }

        .bg-preview { width:100%; height:70px; border-radius:8px; margin-bottom:10px; border:1px solid rgba(0,0,0,0.06); }

        /* Active quest full-screen view */
        #active-quest-screen { display:none; position:fixed; inset:0; z-index:3000; align-items:center; justify-content:center; padding:24px; color:white; }
        #active-quest-screen .active-quest-card {
            width:100%; max-width:800px;
            background: linear-gradient(135deg, #bdbdbd 0%, #667eea 100%);
            border-radius:12px; padding:40px; box-shadow:0 12px 40px rgba(0,0,0,0.35); text-align:center; color:#fff;
        }
        #active-quest-screen .active-quest-title { font-size:28px; font-weight:800; margin-bottom:12px; }
        #active-quest-screen .active-quest-description { font-size:18px; color: rgba(255,255,255,0.9); margin-bottom:28px; }
        #active-quest-screen .mark-complete-btn { background:#4caf50; color:white; border:none; padding:14px 28px; border-radius:8px; font-weight:800; font-size:18px; cursor:pointer; transition:background 0.2s; }
        #active-quest-screen .mark-complete-btn:hover { background:#3f9a3f; }
        #active-quest-screen .cancel-quest-btn { background: rgba(255,255,255,0.15); color:white; border:none; padding:10px 18px; border-radius:8px; font-weight:700; font-size:14px; cursor:pointer; margin-left:12px; }
        #active-quest-screen .cancel-quest-btn { background: rgba(255,255,255,0.15); color:white; border:none; padding:10px 18px; border-radius:8px; font-weight:700; font-size:14px; cursor:pointer; margin-left:10px; }

        /* inspirational bubble inside active quest */
        .inspire-bubble {
@@ -454,6 +454,13 @@
            .login-animation-card, .qc-card { animation: none !important; transform: none !important; }
            .inspire-bubble { transition: none !important; transform: none !important; opacity: 1 !important; }
        }

        /* Profile strip (uses CSS variable set by JS) */
        #profile-strip {
            padding: 15px;
            background: var(--profile-strip-bg, #f5f5f5);
            transition: background 260ms ease;
        }
    </style>
</head>
<body>
@@ -488,7 +495,7 @@
        <p style="margin: 10px 0 0 0; opacity: 0.9;">Complete daily fitness and wellness challenges</p>
    </div>

    <div class="user-profile-details-style" style="padding: 15px; background: #f5f5f5;">
    <div id="profile-strip" class="user-profile-details-style">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center;">
                <span class="profile-avatar" id="user-avatar">üë§</span>
@@ -615,7 +622,7 @@
        </div>
        <div class="terms-body">
            <h3>Introduction</h3>
            <p>Welcome to QuestBoard! QuestBoard (‚Äúthe App‚Äù) is a health application designed to help users build healthy habits through fun, RPG-style gamification. By accessing or using QuestBoard you agree to these terms.</p>
            <p>Welcome to QuestBoard! QuestBoard (‚Äúthe App‚Äù) is a health application designed to help users build healthy habits through fun, RPG-style gamification. By accessing or using QuestBoard you accept these terms.</p>

            <h3>User Eligibility</h3>
            <p>QuestBoard is intended for individuals aged 13 and older. Users under 18 must have parental consent to register and use the App.</p>
@@ -681,6 +688,7 @@
    let equippedTitle = localStorage.getItem('equippedTitle') || '';
    let equippedBackground = localStorage.getItem('equippedBackground') || null;
    let currentQuests = [];
    let activeQuestId = null;

    const CUSTOM_QUESTS_KEY = 'customQuests_v1';
    const DAILY_COMPLETIONS_KEY = 'dailyCompletions_v1';
@@ -689,14 +697,14 @@
    const STREAK_REQUIREMENT = 3;
    const STREAK_BONUS_PERCENT_PER_STREAK = 0.10;

    // Background styles mapping
    // Background styles mapping (brighter body colors + a related strip shade)
    const BG_STYLES = {
        bg_light_blue: '#e8f5ff', // light blue
        bg_pink: '#fff0f8', // pink
        bg_light_gray: '#f5f5f5', // light gray
        bg_blue_gray_grad: 'linear-gradient(135deg,#e8f5ff,#f5f5f5)', // light blue + light gray
        bg_pink_gray_grad: 'linear-gradient(135deg,#fff0f8,#f5f5f5)', // pink + light gray
        bg_blue_pink_grad: 'linear-gradient(135deg,#e8f5ff,#fff0f8)' // light blue + pink
        bg_light_blue: { body: '#eaf6ff', strip: '#d7efff' },
        bg_pink: { body: '#fff4f8', strip: '#ffe9f0' },
        bg_light_gray: { body: '#fbfbfb', strip: '#f0f0f0' },
        bg_blue_gray_grad: { body: 'linear-gradient(135deg,#f0f9ff,#f7f7fb)', strip: 'linear-gradient(135deg,#e6f4ff,#eef0f6)' },
        bg_pink_gray_grad: { body: 'linear-gradient(135deg,#fff6fb,#f7f7fb)', strip: 'linear-gradient(135deg,#ffeef6,#f0eef3)' },
        bg_blue_pink_grad: { body: 'linear-gradient(135deg,#f0fbff,#fff6fb)', strip: 'linear-gradient(135deg,#e6f8ff,#fff0f6)' }
    };

    // Shop items
@@ -766,7 +774,7 @@
    // UI helpers
    function showMessage(text, ms = 2200) {
        const message = document.createElement('div');
        message.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.85);color:white;padding:16px 22px;border-radius:10px;z-index:9999;text-align:center;font-weight:700;';
        message.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.85);color:white;padding:16px 22px;border-radius:10px;z-index:9999;text-align:center;max-width:80%;';
        message.innerHTML = text;
        document.body.appendChild(message);
        setTimeout(()=>message.remove(), ms);
@@ -777,14 +785,20 @@
        if (!id) {
            document.body.style.background = '';
            document.body.style.backgroundColor = '';
            document.documentElement.style.setProperty('--profile-strip-bg', '#f5f5f5');
            return;
        }
        const style = BG_STYLES[id];
        if (!style) return;
        document.body.style.background = style;
        if (!style.includes('gradient')) {
            document.body.style.backgroundColor = style;
        const styleObj = BG_STYLES[id];
        if (!styleObj) return;
        const bodyStyle = styleObj.body;
        const stripStyle = styleObj.strip || bodyStyle;
        document.body.style.background = bodyStyle;
        // if bodyStyle is not gradient, also set backgroundColor for better contrast
        if (!String(bodyStyle).includes('gradient')) {
            document.body.style.backgroundColor = bodyStyle;
        }
        // set CSS variable for profile strip
        document.documentElement.style.setProperty('--profile-strip-bg', stripStyle);
    }

    // Streak UI
@@ -798,7 +812,7 @@
        streakUi.appendChild(badge);
        const help = document.createElement('div');
        help.className = 'streak-help';
        help.innerHTML = `Complete ${STREAK_REQUIREMENT} quests every day to build streaks ‚Äî each streak gives +${Math.round(STREAK_BONUS_PERCENT_PER_STREAK*100)}% coins per quest. Best: <strong id="best-streak">${streakData.bestStreak}</strong>`;
        help.innerHTML = `Complete ${STREAK_REQUIREMENT} quests every day to build streaks ‚Äî each streak gives +${Math.round(STREAK_BONUS_PERCENT_PER_STREAK*100)}% coins per quest. Best: <strong id="streak-best">${streakData.bestStreak}</strong>`;
        streakUi.appendChild(help);
    }

@@ -882,6 +896,14 @@
        }
    };

    // small helper
    function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/[&<>"']/g, function (m) {
            return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m];
        });
    }

    // Login
    document.getElementById('loginForm').addEventListener('submit', function(e){
        e.preventDefault();
@@ -968,6 +990,50 @@
    }
    window.deleteCustomQuest = deleteCustomQuest;

    // start quest (minimal)
    function startQuest(questId) {
        const quest = currentQuests.find(q=>String(q.quest_id)===String(questId));
        if (!quest) return;
        activeQuestId = questId;
        const screen = document.getElementById('active-quest-screen');
        screen.querySelector('.active-quest-title').textContent = quest.title;
        screen.querySelector('.active-quest-description').textContent = quest.description;
        screen.style.display = 'flex';
        document.getElementById('inspire-bubble').classList.add('show');
    }
    window.startQuest = startQuest;

    // complete quest (minimal)
    function completeQuest(questId) {
        const key = 'quest_' + questId;
        localStorage.setItem(key, 'completed');
        // award base coins (10) plus streak bonus
        let base = 10;
        const streakData = loadStreakData();
        const bonusPct = (streakData.currentStreak || 0) * STREAK_BONUS_PERCENT_PER_STREAK;
        const award = Math.round(base * (1 + bonusPct));
        coins += award;
        updateCoins();
        saveDailyCompletions(loadDailyCompletions()); // ensure saved
        recordCompletionAndMaybeAwardStreak();
        showQuestCompleteOverlay(award);
        loadQuests();
    }
    window.completeQuest = completeQuest;

    function showQuestCompleteOverlay(coinsAwarded) {
        const overlay = document.getElementById('quest-complete-overlay');
        overlay.innerHTML = `
            <div class="qc-card">
                <div class="qc-title">Quest Completed!</div>
                <div class="qc-sub">Great work ‚Äî you've earned:</div>
                <div class="qc-coins"><div class="qc-coin">üí∞ ${coinsAwarded}</div></div>
            </div>
        `;
        overlay.classList.add('show');
        setTimeout(()=>{ overlay.classList.remove('show'); overlay.innerHTML=''; }, 2200);
    }

    // Load quests
    function loadQuests() {
        const questList = document.getElementById('quest-list');
@@ -990,446 +1056,62 @@
            questCard.setAttribute('data-quest-id', quest.quest_id);
            if (quest.category === 'custom') questCard.setAttribute('data-custom','true');
            const isCompleted = localStorage.getItem('quest_' + quest.quest_id) === 'completed';
            const categoryClass = 'category-' + (quest.category || 'custom');
            const statusClass = isCompleted ? 'completed' : (quest.status || 'active');
            questCard.innerHTML = `
                <div>
                    <span class="quest-category category-${quest.category}">${quest.category}</span>
                    <span class="quest-status ${isCompleted ? 'completed' : quest.status}">
                        ${isCompleted ? 'COMPLETED' : quest.status.toUpperCase()}
                    <span class="quest-category ${categoryClass}">${escapeHtml(quest.category || '')}</span>
                    <span class="quest-status ${statusClass}">
                        ${isCompleted ? 'COMPLETED' : (quest.status || 'ACTIVE').toUpperCase()}
                    </span>
                </div>
                <div class="quest-title">${escapeHtml(quest.title)}</div>
                <div class="quest-description">${escapeHtml(quest.description)}</div>
                <div>
                    <button class="complete-btn" onclick="completeQuest(${quest.quest_id})" ${isCompleted ? 'disabled' : ''}>
                        ${isCompleted ? '‚úì Completed' : 'Mark as Complete'}
                    </button>
                    <button class="start-btn" onclick="startQuest(${quest.quest_id})">‚ñ∂ Start</button>
                    ${quest.category === 'custom' ? `<button class="delete-btn" onclick="deleteCustomQuest(${quest.quest_id})">Delete</button>` : ''}
                    <button class="start-btn" onclick="startQuest('${quest.quest_id}')">Start</button>
                    <button class="complete-btn" onclick="completeQuest('${quest.quest_id}')" ${isCompleted ? 'disabled' : ''}>Complete</button>
                    ${quest.custom ? `<button class="delete-btn" onclick="deleteCustomQuest('${quest.quest_id}')">Delete</button>` : ''}
                </div>
            `;
            questList.appendChild(questCard);
        });
    }

    document.getElementById('refresh-quests').addEventListener('click', function(){ loadQuests(); });

    document.getElementById('quest-filter').addEventListener('change', function(){ loadQuests(); });

    // Escape HTML for user input
    function escapeHtml(text) {
        return String(text)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }
    document.getElementById('refresh-quests').addEventListener('click', loadQuests);
    document.getElementById('quest-filter').addEventListener('change', loadQuests);

    // Inspirational phrases logic
    const INSPIRATIONAL_PHRASES = [
        "You got this!",
        "Keep going!",
        "Almost there!",
        "Stay strong!",
        "Nice work!",
        "One step at a time!"
    ];

    function startInspirationalPhrases() {
        const bubble = document.getElementById('inspire-bubble');
        if (!bubble) return;
        // clear any existing
        stopInspirationalPhrases();

        let idx = 0;
        bubble.textContent = INSPIRATIONAL_PHRASES[idx];
        bubble.setAttribute('aria-hidden','false');
        bubble.classList.add('show');

        // cycle phrases every ~1.8s with a small fade
        window._inspireInterval = setInterval(() => {
            bubble.classList.remove('show');
            // small fade duration to match CSS
            setTimeout(() => {
                idx = (idx + 1) % INSPIRATIONAL_PHRASES.length;
                bubble.textContent = INSPIRATIONAL_PHRASES[idx];
                bubble.classList.add('show');
            }, 300);
        }, 1800);
    }

    function stopInspirationalPhrases() {
        const bubble = document.getElementById('inspire-bubble');
        if (window._inspireInterval) {
            clearInterval(window._inspireInterval);
            delete window._inspireInterval;
        }
        if (bubble) {
            bubble.classList.remove('show');
            bubble.setAttribute('aria-hidden','true');
            // clear text after a short delay so fade-out looks natural
            setTimeout(() => { if (bubble) bubble.textContent = ''; }, 300);
        }
    }

    // Active quest screen
    function startQuest(questId) {
        const quest = currentQuests.find(q => Number(q.quest_id) === Number(questId));
        const activeScreen = document.getElementById('active-quest-screen');
        if (!activeScreen) return;
        const titleEl = activeScreen.querySelector('.active-quest-title');
        const descEl = activeScreen.querySelector('.active-quest-description');
        if (quest) { if (titleEl) titleEl.textContent = quest.title; if (descEl) descEl.textContent = quest.description; }
        else { if (titleEl) titleEl.textContent = 'Active Quest'; if (descEl) descEl.textContent = 'Complete this quest and mark it as completed when finished.'; }
        activeScreen.setAttribute('data-active-quest-id', questId);
        document.getElementById('main-content').style.display = 'none';
        activeScreen.style.display = 'flex';
        const btn = document.getElementById('mark-complete-btn'); if (btn) btn.focus();

        // start inspirational phrases while the quest is active
        startInspirationalPhrases();
    }
    window.startQuest = startQuest;

    document.getElementById('cancel-quest-btn').addEventListener('click', function(){
        const activeScreen = document.getElementById('active-quest-screen');
        activeScreen.style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        // stop inspirational phrases when user returns to board
        stopInspirationalPhrases();
    });

    // Mark active quest completed ‚Äî updated to show animation when finished via "Start"
    document.getElementById('mark-complete-btn').addEventListener('click', function(){
        const activeScreen = document.getElementById('active-quest-screen');
        const questIdAttr = activeScreen.getAttribute('data-active-quest-id');
        if (!questIdAttr) { activeScreen.style.display = 'none'; document.getElementById('main-content').style.display = 'block'; return; }
        const questId = Number(questIdAttr);

        // stop inspirational phrases first
        stopInspirationalPhrases();

        // show an animated celebration, then complete the quest and return to board
        showQuestCompleteAnimation(questId, function() {
            // hide active screen and return to main board
            activeScreen.style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
        });
    });

    // Complete quest (handles custom coin amount + streak bonus)
    function completeQuest(questId) {
        // stop phrases if still running (covers direct completions)
        stopInspirationalPhrases();

        const questCard = document.querySelector(`[data-quest-id="${questId}"]`);
        let isCustom = false;
        if (questCard) {
            questCard.setAttribute('data-completed','true');
            const statusSpan = questCard.querySelector('.quest-status');
            const completeBtn = questCard.querySelector('.complete-btn');
            if (statusSpan) { statusSpan.className = 'quest-status completed'; statusSpan.textContent = 'COMPLETED'; }
            if (completeBtn) { completeBtn.disabled = true; completeBtn.textContent = '‚úì Completed'; }
            if (questCard.getAttribute('data-custom') === 'true') isCustom = true;
        }
        if (!isCustom) {
            const found = currentQuests.find(q => Number(q.quest_id) === Number(questId));
            if (found && found.category === 'custom') isCustom = true;
            else if (!found) {
                const customQuests = loadCustomQuestsFromStorage();
                if (customQuests.find(q => Number(q.quest_id) === Number(questId))) isCustom = true;
            }
        }
        localStorage.setItem('quest_' + questId, 'completed');

        // record daily completions & streaks
        const streakUpdate = recordCompletionAndMaybeAwardStreak();
        const streakData = loadStreakData();
        const currentStreak = streakData.currentStreak || 0;

        const base = isCustom ? 5 : 10;
        const bonus = Math.floor(base * STREAK_BONUS_PERCENT_PER_STREAK * currentStreak);
        const coinsEarned = base + bonus;
        coins += coinsEarned;
        updateCoins();

        // celebration with breakdown ‚Äî shown only when not suppressed by an external animation
        if (!window.QUIET_COMPLETE) {
            const celebration = document.createElement('div');
            celebration.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#4caf50;color:white;padding:20px 30px;border-radius:10px;font-size:18px;z-index:2000;text-align:center;font-weight:700;';
            celebration.innerHTML = `üéâ Quest Completed!<br><span style="font-size:16px;">+${base} base coins${bonus>0?(' +'+bonus+' streak bonus'):''} = <strong>+${coinsEarned} coins</strong></span>`;
            document.body.appendChild(celebration);
            setTimeout(()=>celebration.remove(), 2600);
        }

        updateStreakUI();
        return coinsEarned;
    }
    window.completeQuest = completeQuest;

    // Shop rendering & actions
    // Shop loading (minimal visual)
    function loadShop() {
        const shopData = window.questBoardAPI.getShopItems();
        renderBackgroundItems(shopData.backgrounds, 'backgrounds-grid');
        renderShopItems(shopData.avatars, 'avatars-grid', 'avatar');
        renderShopItems(shopData.cosmetics, 'cosmetics-grid', 'cosmetic');
        renderCrateItems(shopData.vip_crates, 'crates-grid');
        updateCoins();
    }

    function renderBackgroundItems(items, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        items.forEach(item => {
            const owned = ownedItems.includes(item.id);
            const equipped = (equippedBackground === item.id);
            const itemDiv = document.createElement('div');
            itemDiv.className = 'shop-item' + (owned ? ' owned' : '') + (equipped ? ' equipped' : '');
            const previewStyle = BG_STYLES[item.id] || '#fff';
            itemDiv.innerHTML = `
                <div class="bg-preview" style="background: ${previewStyle};"></div>
                <div class="shop-item-name">${item.name}</div>
                <div class="shop-item-price">${owned ? 'Owned' : item.price + ' coins'}</div>
                ${!owned ? `<button class="buy-btn" onclick="buyItem('${item.id}', ${item.price}, 'background')">Buy - ${item.price} üí∞</button>` :
                    (equipped ? `<button class="equip-btn" disabled>Equipped ‚úì</button>` : `<button class="equip-btn" onclick="equipBackground('${item.id}')">Equip</button>`)
                }
            `;
            container.appendChild(itemDiv);
        });
    }

    function equipBackground(itemId) {
        equippedBackground = itemId;
        localStorage.setItem('equippedBackground', itemId);
        applyBackground(itemId);
        loadShop();
        showMessage('Background equipped');
    }
    window.equipBackground = equipBackground;

    function renderShopItems(items, containerId, itemType) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        items.forEach(item => {
            const owned = ownedItems.includes(item.id);
            const equipped = (itemType === 'avatar' && equippedAvatar === item.emoji) ||
                            (item.type === 'title' && equippedTitle === item.emoji + ' ' + item.name);
            const itemDiv = document.createElement('div');
            itemDiv.className = 'shop-item' + (owned ? ' owned' : '') + (equipped ? ' equipped' : '');
            let buttonHTML = '';
            if (!owned) buttonHTML = `<button class="buy-btn" onclick="buyItem('${item.id}', ${item.price}, '${itemType}')">Buy - ${item.price} üí∞</button>`;
            else if (!equipped && (itemType === 'avatar' || item.type === 'title')) buttonHTML = `<button class="equip-btn" onclick="equipItem('${item.id}', '${item.emoji}', '${item.name}', '${item.type}')">Equip</button>`;
            else if (equipped) buttonHTML = `<button class="equip-btn" disabled>Equipped ‚úì</button>`;
            else buttonHTML = `<button class="buy-btn" disabled>Owned ‚úì</button>`;
            itemDiv.innerHTML = `
                <div class="shop-item-emoji">${item.emoji}</div>
                <div class="shop-item-name">${item.name}</div>
                <div class="shop-item-price">${owned ? 'Owned' : item.price + ' coins'}</div>
                ${buttonHTML}
            `;
            container.appendChild(itemDiv);
        });
    }

    function renderCrateItems(crates, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        crates.forEach(crate => {
            const crateDiv = document.createElement('div');
            crateDiv.className = 'shop-item';
            crateDiv.style.cursor = 'pointer';
            crateDiv.innerHTML = `
                <div class="shop-item-emoji">${crate.emoji}</div>
                <div class="shop-item-name">${crate.name}</div>
                <div style="font-size:12px;color:#ff9800;margin:5px 0;">VIP ${crate.vip_required}+ Required</div>
                <div class="shop-item-price">${crate.price} coins</div>
                <div style="font-size:11px;color:#666;margin-top:5px;">${crate.description}</div>
                <button class="buy-btn" onclick="openCrate('${crate.id}', ${crate.price}, ${crate.vip_required})">Open Crate</button>
            `;
            container.appendChild(crateDiv);
        });
    }

    function buyItem(itemId, price, itemType) {
        if (coins >= price) {
            coins -= price;
            if (!ownedItems.includes(itemId)) ownedItems.push(itemId);
            localStorage.setItem('coins', coins);
            localStorage.setItem('ownedItems', JSON.stringify(ownedItems));
            updateCoins();
            loadShop();
            const message = document.createElement('div');
            message.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#4caf50;color:white;padding:20px 40px;border-radius:10px;font-size:20px;z-index:2000;text-align:center;font-weight:700;';
            message.textContent = '‚úì Purchase Successful!';
            document.body.appendChild(message);
            setTimeout(()=>message.remove(), 1500);
        } else { alert('Not enough coins! Complete more quests to earn coins.'); }
    }
    window.buyItem = buyItem;

    function equipItem(itemId, emoji, name, type) {
        if (type === 'avatar') {
            equippedAvatar = emoji;
            localStorage.setItem('equippedAvatar', equippedAvatar);
        } else if (type === 'title') {
            equippedTitle = emoji + ' ' + name;
            localStorage.setItem('equippedTitle', equippedTitle);
        }
        updateProfile();
        loadShop();
        showMessage('Item equipped');
    }
    window.equipItem = equipItem;

    function openCrate(crateId, price, vipRequired) {
        if (coins < price) { alert('Not enough coins to open this crate.'); return; }
        coins -= price;
        const shop = window.questBoardAPI.getShopItems();
        document.getElementById('backgrounds-grid').innerHTML = shop.backgrounds.map(b=>`<div class="shop-item" onclick="(function(){ applyBackground('${b.id}'); localStorage.setItem('equippedBackground','${b.id}'); showMessage('Background applied'); })()"><div class="shop-item-emoji">${b.emoji}</div><div class="shop-item-name">${b.name}</div><div class="shop-item-price">${b.price} coins</div></div>`).join('');
        document.getElementById('avatars-grid').innerHTML = shop.avatars.map(a=>`<div class="shop-item"><div class="shop-item-emoji">${a.emoji}</div><div class="shop-item-name">${a.name}</div><div class="shop-item-price">${a.price} coins</div></div>`).join('');
        document.getElementById('cosmetics-grid').innerHTML = shop.cosmetics.map(c=>`<div class="shop-item"><div class="shop-item-emoji">${c.emoji}</div><div class="shop-item-name">${c.name}</div><div class="shop-item-price">${c.price} coins</div></div>`).join('');
        document.getElementById('crates-grid').innerHTML = shop.vip_crates.map(c=>`<div class="shop-item"><div class="shop-item-emoji">${c.emoji}</div><div class="shop-item-name">${c.name}</div><div style="font-size:13px;color:#666">${c.description}</div><div class="shop-item-price">${c.price} coins</div></div>`).join('');
        updateCoins();
        // simple random reward simulation
        const rewards = ["avatar_1","border_1","title_1","avatar_3"];
        const reward = rewards[Math.floor(Math.random()*rewards.length)];
        if (!ownedItems.includes(reward)) ownedItems.push(reward);
        localStorage.setItem('ownedItems', JSON.stringify(ownedItems));
        loadShop();
        showMessage('üéÅ Crate opened! You received: ' + reward);
    }
    window.openCrate = openCrate;

    function buyQuestMaster() {
        alert('QuestMaster is currently unavailable in this demo.');
    }

    // --- Login animation functions (NEW) ---
    // small login animation
    function showLoginAnimation(username, cb) {
        const overlay = document.getElementById('login-animation-overlay');
        if (!overlay) {
            if (typeof cb === 'function') cb();
            return;
        }
        // set username in welcome message
        const nameEl = document.getElementById('login-username');
        if (nameEl) nameEl.textContent = username;

        document.getElementById('login-username').textContent = username;
        overlay.classList.add('show');

        // create confetti pieces
        const colors = ['#ffd700', '#ff6b6b', '#6bf0c4', '#8e9bff', '#ffd9a8'];
        const pieces = 22;
        const created = [];
        for (let i = 0; i < pieces; i++) {
            const c = document.createElement('div');
            c.className = 'login-confetti';
            const left = Math.random() * 80 + 10; // 10% - 90%
            c.style.left = left + '%';
            c.style.background = colors[Math.floor(Math.random() * colors.length)];
            c.style.setProperty('--dur', (900 + Math.floor(Math.random() * 700)) + 'ms');
            c.style.transform = `translateY(0) rotate(${Math.floor(Math.random()*360)}deg)`;
            // stagger delay
            c.style.animationDelay = (Math.random() * 220) + 'ms';
            overlay.appendChild(c);
            created.push(c);
        }

        // duration for the whole overlay (slightly longer than confetti animation)
        const totalMs = 1600;
        setTimeout(() => {
            // clean confetti
            created.forEach(el => el.remove());
            overlay.classList.remove('show');
            // small delay to allow fade-out
            setTimeout(() => {
                if (typeof cb === 'function') cb();
            }, 260);
        }, totalMs);
        setTimeout(()=>{ overlay.classList.remove('show'); cb && cb(); }, 900);
    }

    // --- Quest completion animation (NEW) ---
    // When user finishes a quest via the "Start" flow (fullscreen active quest),
    // show a full-screen celebratory animation, then call completeQuest (quietly)
    function showQuestCompleteAnimation(questId, cb) {
        const overlay = document.getElementById('quest-complete-overlay');
        if (!overlay) {
            // fallback: just complete and callback
            completeQuest(questId);
            if (typeof cb === 'function') cb();
            return;
        }
    // small buy helper stub
    function buyQuestMaster() { alert('Purchase flow not implemented in demo.'); }

        // ensure phrases stopped
        stopInspirationalPhrases();
    // initialize UI from stored values
    updateCoins();
    updateProfile();
    updateStreakUI();
    applyBackground(equippedBackground);

        // create card content
        overlay.innerHTML = ''; // clear
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden', 'false');

        const card = document.createElement('div');
        card.className = 'qc-card';
        const title = document.createElement('div');
        title.className = 'qc-title';
        title.textContent = 'Quest Completed!';
        const sub = document.createElement('div');
        sub.className = 'qc-sub';
        sub.textContent = 'Great job ‚Äî rewards incoming.';
        const coinsBox = document.createElement('div');
        coinsBox.className = 'qc-coins';
        coinsBox.innerHTML = `<div class="qc-coin">+<span id="qc-coin-amount">0</span> üí∞</div>`;

        card.appendChild(title);
        card.appendChild(sub);
        card.appendChild(coinsBox);
        overlay.appendChild(card);

        // small confetti burst
        const colors = ['#ffd700', '#ff6b6b', '#6bf0c4', '#8e9bff', '#ffd9a8'];
        const pieces = 18;
        const created = [];
        for (let i = 0; i < pieces; i++) {
            const c = document.createElement('div');
            c.className = 'qc-confetti';
            const left = Math.random() * 80 + 10; // 10% - 90%
            c.style.left = left + '%';
            c.style.background = colors[Math.floor(Math.random() * colors.length)];
            c.style.animationDelay = (Math.random() * 240) + 'ms';
            overlay.appendChild(c);
            created.push(c);
        }

        // Suppress the small inline celebration in completeQuest while we run our animation
        window.QUIET_COMPLETE = true;

        // call completeQuest immediately so coins and streaks update (but its celebration is suppressed)
        const coinsEarned = completeQuest(questId);

        // update number in overlay
        const qcAmount = document.getElementById('qc-coin-amount');
        if (qcAmount) qcAmount.textContent = coinsEarned;

        // animation duration
        const totalMs = 1600;
        // after animation, clean up & callback
        setTimeout(() => {
            // remove confetti pieces
            created.forEach(el => el.remove());
            overlay.classList.remove('show');
            overlay.setAttribute('aria-hidden', 'true');
            // small delay to allow fade-out
            setTimeout(() => {
                // restore celebration behavior
                window.QUIET_COMPLETE = false;
                overlay.innerHTML = '';
                if (typeof cb === 'function') cb();
            }, 260);
        }, totalMs);
    }
    window.showQuestCompleteAnimation = showQuestCompleteAnimation;
    // Expose some functions for debugging
    window.applyBackground = applyBackground;
    window.loadQuests = loadQuests;
    window.loadShop = loadShop;

    // Initialize UI on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateCoins(); updateProfile(); updateStreakUI(); applyBackground(equippedBackground);
        // Preload quests when logged-in; initial state hides main content
    });
</script>

</body>
