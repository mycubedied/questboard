<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Quest Board</title>
    <script type="module" src="/main.js"></script>
    <style>
        .quest-board-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .quest-board-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .quest-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .quest-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .quest-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .quest-description {
            color: #666;
            margin-bottom: 10px;
        }

        .quest-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .quest-status.active {
            background: #4caf50;
            color: white;
        }

        .quest-status.pending {
            background: #ff9800;
            color: white;
        }

        .quest-status.completed {
            background: #2196f3;
            color: white;
        }

        .quest-category {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 10px;
            text-transform: uppercase;
        }

        .category-cardio { background: #e3f2fd; color: #1976d2; }
        .category-strength { background: #fce4ec; color: #c2185b; }
        .category-flexibility { background: #f3e5f5; color: #7b1fa2; }
        .category-wellness { background: #e8f5e9; color: #388e3c; }
        .category-custom { background: #eceff1; color: #37474f; }

        .complete-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .complete-btn:hover { background: #45a049; }
        .complete-btn:disabled { background: #cccccc; cursor: not-allowed; }

        .start-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            margin-left: 10px;
            transition: background 0.3s;
        }

        .start-btn:hover { background: #1976d2; }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .refresh-btn:hover { background: #5568d3; }

        .coin-display {
            background: #ffd700;
            color: #333;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 18px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .shop-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            margin-left: 10px;
        }

        .shop-btn:hover { background: #f57c00; }

        .shop-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .shop-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 15px;
        }

        .shop-close { font-size: 32px; font-weight: bold; color: #999; cursor: pointer; transition: color 0.3s; }
        .shop-close:hover { color: #333; }

        .shop-section { margin-bottom: 30px; }
        .shop-section h3 { color: #667eea; margin-bottom: 15px; }
        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .shop-item {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .shop-item:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .shop-item.owned { border-color: #4caf50; background: #e8f5e9; }
        .shop-item.equipped { border-color: #ffd700; background: #fffde7; }
        .shop-item-emoji { font-size: 48px; margin-bottom: 10px; }
        .shop-item-name { font-weight: bold; margin-bottom: 5px; }
        .shop-item-price { color: #ffd700; font-weight: bold; font-size: 16px; }

        .buy-btn { background: #4caf50; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px; font-weight: bold; }
        .buy-btn:hover { background: #45a049; }
        .buy-btn:disabled { background: #ccc; cursor: not-allowed; }

        .equip-btn { background: #2196f3; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px; font-weight: bold; }
        .equip-btn:hover { background: #1976d2; }

        .profile-avatar { font-size: 48px; margin-right: 10px; }
        .profile-title { color: #667eea; font-weight: bold; margin-left: 10px; }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header h2 { color: #667eea; margin: 0; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; box-sizing: border-box; }
        .form-group input:focus { outline: none; border-color: #667eea; }

        .btn-login {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .btn-login:hover { opacity: 0.9; }

        .signup-link { text-align: center; margin-top: 20px; color: #666; }
        .signup-link a { color: #667eea; text-decoration: none; font-weight: bold; }
        .signup-link a:hover { text-decoration: underline; }

        .error-message { color: #f44336; font-size: 14px; margin-top: 10px; text-align: center; }

        #main-content { display: none; }

        /* New styles for quest filter dropdown and helpers */
        .quest-controls { display: flex; gap: 12px; align-items: center; }
        .quest-filter { padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px; background: white; }
        .quest-filter:focus { outline: none; border-color: #667eea; }

        /* Small form for adding custom quests */
        .custom-quest-form {
            margin: 18px 0;
            padding: 12px;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .custom-quest-form input[type="text"] {
            flex: 1 1 240px;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 14px;
        }

        .custom-quest-form textarea {
            flex: 2 1 360px;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 14px;
            resize: vertical;
            min-height: 48px;
        }

        .add-custom-btn {
            background: #00bfa5;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .add-custom-btn:hover { background: #009e90; }

        /* Streak UI helper */
        .streak-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }

        .streak-badge {
            background: linear-gradient(90deg,#ff7043,#ffca28);
            color: white;
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: bold;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .streak-help {
            font-size: 12px;
            color: #444;
            opacity: 0.85;
        }

        /* Active quest full-screen view */
        #active-quest-screen {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 3000;
            align-items: center;
            justify-content: center;
            padding: 24px;
            color: white;
        }

        #active-quest-screen .active-quest-card {
            width: 100%;
            max-width: 800px;
            background: linear-gradient(135deg, #bdbdbd 0%, #667eea 100%); /* gray -> blue gradient */
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.35);
            text-align: center;
            color: #fff;
        }

        #active-quest-screen .active-quest-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 12px;
        }

        #active-quest-screen .active-quest-description {
            font-size: 18px;
            color: rgba(255,255,255,0.9);
            margin-bottom: 28px;
        }

        #active-quest-screen .mark-complete-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-weight: 800;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.2s;
        }

        #active-quest-screen .mark-complete-btn:hover { background: #3f9a3f; }

        #active-quest-screen .cancel-quest-btn {
            background: rgba(255,255,255,0.15);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            margin-left: 12px;
        }

        @media (max-width: 600px) {
            #active-quest-screen .active-quest-card { padding: 22px; }
            #active-quest-screen .active-quest-title { font-size: 22px; }
            #active-quest-screen .mark-complete-btn { width: 100%; display: block; margin-bottom: 8px; }
            #active-quest-screen .cancel-quest-btn { width: 100%; display: block; margin-top: 8px; }
            .custom-quest-form { flex-direction: column; align-items: stretch; }
            .streak-info { align-items: center; }
        }
    </style>
</head>
<body>

<!-- Login Page -->
<div id="login-page">
    <div class="login-container">
        <div class="login-header">
            <h2>üéØ Quest Board Login</h2>
            <p style="color: #666; margin-top: 10px;">Sign in to view your quests</p>
        </div>
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" required placeholder="Enter your username">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required placeholder="Enter your password">
            </div>
            <button type="submit" class="btn-login">Login</button>
            <div class="error-message" id="error-message"></div>
        </form>
        <div class="signup-link">
            Don't have an account? <a href="#" id="signup-link">Sign up</a>
        </div>
    </div>
</div>

<!-- Main Quest Board (Hidden until login) -->
<div id="main-content">
    <div class="quest-board-header">
        <h1 style="margin: 0; font-size: 32px;">üí™ Daily Health Quest Board</h1>
        <p style="margin: 10px 0 0 0; opacity: 0.9;">Complete daily fitness and wellness challenges</p>
    </div>

    <div class="user-profile-details-style" style="padding: 15px; background: #f5f5f5;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center;">
                <span class="profile-avatar" id="user-avatar">üë§</span>
                <div>
                    <span id="user_status">Welcome, Adventurer!</span>
                    <span class="profile-title" id="user-title"></span>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:12px;">
                <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end;">
                    <div class="coin-display">
                        <span>üí∞</span>
                        <span id="coin-count">0</span>
                        <span>coins</span>
                    </div>
                    <div id="streak-ui" class="streak-info" style="align-items:flex-end;">
                        <!-- Streak badge & help will be injected here -->
                    </div>
                </div>
                <div>
                    <button id="shop-btn" class="shop-btn">üõí Shop</button>
                    <button id="logout-btn" style="padding: 8px 20px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer;">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <div class="quest-board-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h2 style="color: #333; margin: 0;">Your Daily Health Quests</h2>
            <div class="quest-controls">
                <select id="quest-filter" class="quest-filter" title="Filter quests by category">
                    <option value="all">All Quests</option>
                    <option value="cardio">Cardio</option>
                    <option value="strength">Strength</option>
                    <option value="flexibility">Flexibility</option>
                    <option value="wellness">Wellness</option>
                    <option value="custom">Custom</option>
                </select>
                <button id="refresh-quests" class="refresh-btn">üîÑ Get New Quests</button>
            </div>
        </div>

        <!-- Custom Quest Form -->
        <div class="custom-quest-form" id="custom-quest-form">
            <input id="custom-title" type="text" placeholder="Custom quest title (e.g. Evening Walk)" />
            <textarea id="custom-description" placeholder="Custom quest description (what to do)"></textarea>
            <button id="add-custom-quest" class="add-custom-btn">Add Custom Quest</button>
        </div>

        <div id="quest-list">
            <!-- Quests will be loaded here dynamically -->
        </div>
    </div>
</div>

<!-- Active Quest Fullscreen View -->
<div id="active-quest-screen" role="dialog" aria-modal="true">
    <div class="active-quest-card" role="document">
        <div class="active-quest-title">Quest Title</div>
        <div class="active-quest-description">Quest description goes here</div>
        <div>
            <button id="mark-complete-btn" class="mark-complete-btn">Mark Quest as Completed</button>
            <button id="cancel-quest-btn" class="cancel-quest-btn">Back to Board</button>
        </div>
    </div>
</div>

<!-- Shop Modal -->
<div id="shop-modal" class="shop-modal">
    <div class="shop-content">
        <div class="shop-header">
            <h2 style="margin: 0;">üõí Quest Shop</h2>
            <span class="shop-close" id="shop-close">&times;</span>
        </div>

        <div style="text-align: center; margin-bottom: 30px;">
            <div class="coin-display" style="font-size: 24px;">
                <span>üí∞</span>
                <span id="shop-coin-count">0</span>
                <span>coins</span>
            </div>
        </div>

        <!-- New Special Offer: QuestMaster -->
        <div class="shop-section">
            <h3>üî• Special Offer</h3>
            <div class="shop-items">
                <div class="shop-item">
                    <div class="shop-item-emoji">üß≠</div>
                    <div class="shop-item-name">QuestMaster</div>
                    <div class="shop-item-price">$6.99</div>
                    <div style="font-size: 12px; color: #666; margin-top: 8px;">Unlock special QuestMaster features</div>
                    <button class="buy-btn" onclick="buyQuestMaster()">Buy QuestMaster - $6.99</button>
                </div>
            </div>
        </div>

        <div class="shop-section">
            <h3>üé≠ Avatars</h3>
            <div class="shop-items" id="avatars-grid">
                <!-- Avatars will be loaded here -->
            </div>
        </div>

        <div class="shop-section">
            <h3>‚ú® Cosmetics</h3>
            <div class="shop-items" id="cosmetics-grid">
                <!-- Cosmetics will be loaded here -->
            </div>
        </div>

        <div class="shop-section">
            <h3>üì¶ VIP Crates</h3>
            <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Special crates with random rewards! VIP level required to open.</p>
            <div class="shop-items" id="crates-grid">
                <!-- VIP Crates will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
    // Global state
    let coins = parseInt(localStorage.getItem('coins')) || 0;
    let ownedItems = JSON.parse(localStorage.getItem('ownedItems')) || [];
    let equippedAvatar = localStorage.getItem('equippedAvatar') || 'üë§';
    let equippedTitle = localStorage.getItem('equippedTitle') || '';
    let currentQuests = []; // store currently generated + custom quests so startQuest can find them

    // Keys
    const CUSTOM_QUESTS_KEY = 'customQuests_v1';
    const DAILY_COMPLETIONS_KEY = 'dailyCompletions_v1'; // map date->count
    const STREAK_DATA_KEY = 'streakData_v1'; // { currentStreak, bestStreak, lastStreakDate }

    // Streak bonus config
    const STREAK_REQUIREMENT = 3; // quests per day required to "earn" the day
    const STREAK_BONUS_PERCENT_PER_STREAK = 0.10; // 10% bonus per streak

    // Utility - today's date string yyyy-mm-dd
    function todayStr(offsetDays = 0) {
        const d = new Date();
        d.setDate(d.getDate() + offsetDays);
        return d.toISOString().slice(0,10);
    }

    // Load/save custom quests
    function loadCustomQuestsFromStorage() {
        try {
            const raw = localStorage.getItem(CUSTOM_QUESTS_KEY);
            return raw ? JSON.parse(raw) : [];
        } catch (e) {
            console.error('Error parsing custom quests', e);
            return [];
        }
    }

    function saveCustomQuestsToStorage(arr) {
        localStorage.setItem(CUSTOM_QUESTS_KEY, JSON.stringify(arr));
    }

    // Daily completions load/save
    function loadDailyCompletions() {
        try {
            const raw = localStorage.getItem(DAILY_COMPLETIONS_KEY);
            return raw ? JSON.parse(raw) : {};
        } catch (e) {
            console.error('Error parsing daily completions', e);
            return {};
        }
    }

    function saveDailyCompletions(obj) {
        localStorage.setItem(DAILY_COMPLETIONS_KEY, JSON.stringify(obj));
    }

    // Streak data load/save
    function loadStreakData() {
        try {
            const raw = localStorage.getItem(STREAK_DATA_KEY);
            if (!raw) {
                return { currentStreak: 0, bestStreak: 0, lastStreakDate: null };
            }
            return JSON.parse(raw);
        } catch (e) {
            console.error('Error parsing streak data', e);
            return { currentStreak: 0, bestStreak: 0, lastStreakDate: null };
        }
    }

    function saveStreakData(obj) {
        localStorage.setItem(STREAK_DATA_KEY, JSON.stringify(obj));
    }

    // Update streak UI area
    function updateStreakUI() {
        const streakUi = document.getElementById('streak-ui');
        const streakData = loadStreakData();
        streakUi.innerHTML = '';

        const badge = document.createElement('div');
        badge.className = 'streak-badge';
        badge.innerHTML = `üî• Streak: <span id="streak-count">${streakData.currentStreak}</span>`;
        streakUi.appendChild(badge);

        const help = document.createElement('div');
        help.className = 'streak-help';
        help.innerHTML = `Complete ${STREAK_REQUIREMENT} quests every day to build streaks ‚Äî each streak gives +${Math.round(STREAK_BONUS_PERCENT_PER_STREAK*100)}% coins per quest. Best: <strong id="best-streak">${streakData.bestStreak}</strong>`;
        streakUi.appendChild(help);
    }

    // Increment daily completion for a date and return whether we newly reached the threshold today
    function incrementDailyCompletionFor(dateStr) {
        const daily = loadDailyCompletions();
        const prev = daily[dateStr] || 0;
        daily[dateStr] = prev + 1;
        saveDailyCompletions(daily);

        // return object with updated count and whether we've now reached threshold (and wasn't reached before)
        return { count: daily[dateStr], reachedNow: (prev < STREAK_REQUIREMENT && daily[dateStr] >= STREAK_REQUIREMENT) };
    }

    // Check & update streaks when a date hits threshold
    function checkAndUpdateStreakFor(dateStr) {
        const streakData = loadStreakData();

        // If we already recorded that this date was the lastStreakDate (i.e., we already processed), don't double-increment
        if (streakData.lastStreakDate === dateStr) {
            return streakData;
        }

        // Did yesterday have a streak (i.e., lastStreakDate === yesterday)?
        const yesterday = todayStr(-1);
        if (streakData.lastStreakDate === yesterday) {
            streakData.currentStreak = (streakData.currentStreak || 0) + 1;
        } else {
            // start a new streak chain
            streakData.currentStreak = 1;
        }

        streakData.lastStreakDate = dateStr;
        if (!streakData.bestStreak || streakData.currentStreak > streakData.bestStreak) {
            streakData.bestStreak = streakData.currentStreak;
        }

        saveStreakData(streakData);
        updateStreakUI();
        return streakData;
    }

    // When user completes a quest, call this to update daily counts and potentially streaks. Returns streakData if updated today, otherwise null
    function recordCompletionAndMaybeAwardStreak() {
        const date = todayStr();
        const res = incrementDailyCompletionFor(date);
        if (res.reachedNow) {
            // Award/advance streak
            const streakData = checkAndUpdateStreakFor(date);
            // notify user
            showMessage(`üéâ You completed ${STREAK_REQUIREMENT} quests today! Streak is now ${streakData.currentStreak}. +${Math.round(STREAK_BONUS_PERCENT_PER_STREAK*100)}% coins per quest per streak.`);
            return streakData;
        }
        return null;
    }

    // Utility to show short messages in center
    function showMessage(text, ms = 2200) {
        const message = document.createElement('div');
        message.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.8); color: white; padding: 18px 28px; border-radius: 10px; z-index: 9999; font-size: 16px; text-align:center;';
        message.innerHTML = text;
        document.body.appendChild(message);
        setTimeout(() => message.remove(), ms);
    }

    // Update coin display
    function updateCoins() {
        const coinElem = document.getElementById('coin-count');
        if (coinElem) coinElem.textContent = coins;
        const shopCoin = document.getElementById('shop-coin-count');
        if (shopCoin) shopCoin.textContent = coins;
        localStorage.setItem('coins', coins);
    }

    // Update avatar and title display
    function updateProfile() {
        const avatarElem = document.getElementById('user-avatar');
        if (avatarElem) avatarElem.textContent = equippedAvatar;
        const titleElem = document.getElementById('user-title');
        if (titleElem) titleElem.textContent = equippedTitle;
    }

    // Login functionality
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const errorMessage = document.getElementById('error-message');

        if (username && password) {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('user_status').textContent = 'Welcome, ' + username + '!';

            updateCoins();
            updateProfile();
            updateStreakUI();
            loadQuests();
        } else {
            errorMessage.textContent = 'Please enter both username and password';
        }
    });

    // Logout
    document.getElementById('logout-btn').addEventListener('click', function() {
        document.getElementById('login-page').style.display = 'block';
        document.getElementById('main-content').style.display = 'none';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('error-message').textContent = '';
    });

    // Signup
    document.getElementById('signup-link').addEventListener('click', function(e) {
        e.preventDefault();
        alert('Signup functionality coming soon!');
    });

    // Shop modal
    document.getElementById('shop-btn').addEventListener('click', function() {
        document.getElementById('shop-modal').style.display = 'block';
        loadShop();
    });

    document.getElementById('shop-close').addEventListener('click', function() {
        document.getElementById('shop-modal').style.display = 'none';
    });

    window.addEventListener('click', function(event) {
        if (event.target == document.getElementById('shop-modal')) {
            document.getElementById('shop-modal').style.display = 'none';
        }
    });

    // Add custom quest button handler
    document.getElementById('add-custom-quest').addEventListener('click', function() {
        const titleInput = document.getElementById('custom-title');
        const descInput = document.getElementById('custom-description');

        const title = (titleInput.value || '').trim();
        const description = (descInput.value || '').trim();

        if (!title) {
            alert('Please enter a title for the custom quest.');
            return;
        }
        if (!description) {
            alert('Please enter a description for the custom quest.');
            return;
        }

        const customQuests = loadCustomQuestsFromStorage();

        const questId = Date.now() + Math.floor(Math.random() * 1000);
        const newQuest = {
            quest_id: questId,
            title: title,
            description: description,
            category: 'custom',
            status: 'active',
            custom: true
        };

        customQuests.push(newQuest);
        saveCustomQuestsToStorage(customQuests);

        titleInput.value = '';
        descInput.value = '';
        loadQuests();
    });

    // Load quests (includes custom quests when appropriate)
    function loadQuests() {
        const questList = document.getElementById('quest-list');
        questList.innerHTML = '<p style="text-align: center; color: #666;">Loading quests...</p>';

        const filter = document.getElementById('quest-filter') ? document.getElementById('quest-filter').value : 'all';

        const generatedQuests = window.questBoardAPI.generateRandomQuests(6, filter === 'all' ? 'all' : filter);
        const customQuests = loadCustomQuestsFromStorage();

        let questsToShow = [];
        if (filter === 'custom') {
            questsToShow = customQuests.slice();
        } else if (filter === 'all') {
            questsToShow = generatedQuests.concat(customQuests);
        } else {
            // specific non-custom category
            questsToShow = generatedQuests.filter(q => q.category === filter);
        }

        currentQuests = questsToShow;
        questList.innerHTML = '';

        if (questsToShow.length === 0) {
            questList.innerHTML = '<p style="text-align:center;color:#666">No quests available for the selected category.</p>';
            return;
        }

        questsToShow.forEach(quest => {
            const questCard = document.createElement('div');
            questCard.className = 'quest-card';
            questCard.setAttribute('data-quest-id', quest.quest_id);
            if (quest.category === 'custom') questCard.setAttribute('data-custom', 'true');

            const isCompleted = localStorage.getItem('quest_' + quest.quest_id) === 'completed';

            questCard.innerHTML = `
                <div>
                    <span class="quest-category category-${quest.category}">${quest.category}</span>
                    <span class="quest-status ${isCompleted ? 'completed' : quest.status}">
                        ${isCompleted ? 'COMPLETED' : quest.status.toUpperCase()}
                    </span>
                </div>
                <div class="quest-title">${escapeHtml(quest.title)}</div>
                <div class="quest-description">${escapeHtml(quest.description)}</div>
                <div>
                    <button class="complete-btn" onclick="completeQuest(${quest.quest_id})" ${isCompleted ? 'disabled' : ''}>
                        ${isCompleted ? '‚úì Completed' : 'Mark as Complete'}
                    </button>
                    <button class="start-btn" onclick="startQuest(${quest.quest_id})">‚ñ∂ Start</button>
                </div>
            `;
            questList.appendChild(questCard);
        });
    }

    // Escape HTML for user input
    function escapeHtml(text) {
        return String(text)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    // Start a quest: show active full-screen view
    function startQuest(questId) {
        const quest = currentQuests.find(q => Number(q.quest_id) === Number(questId));
        const activeScreen = document.getElementById('active-quest-screen');
        if (!activeScreen) return;

        const titleEl = activeScreen.querySelector('.active-quest-title');
        const descEl = activeScreen.querySelector('.active-quest-description');
        if (quest) {
            if (titleEl) titleEl.textContent = quest.title;
            if (descEl) descEl.textContent = quest.description;
        } else {
            if (titleEl) titleEl.textContent = 'Active Quest';
            if (descEl) descEl.textContent = 'Complete this quest and mark it as completed when finished.';
        }

        activeScreen.setAttribute('data-active-quest-id', questId);
        document.getElementById('main-content').style.display = 'none';
        activeScreen.style.display = 'flex';
        const btn = document.getElementById('mark-complete-btn');
        if (btn) btn.focus();
    }

    // Cancel active quest (back to board)
    document.getElementById('cancel-quest-btn').addEventListener('click', function() {
        const activeScreen = document.getElementById('active-quest-screen');
        activeScreen.style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
    });

    // Mark the active quest as completed (active screen)
    document.getElementById('mark-complete-btn').addEventListener('click', function() {
        const activeScreen = document.getElementById('active-quest-screen');
        const questIdAttr = activeScreen.getAttribute('data-active-quest-id');
        if (!questIdAttr) {
            activeScreen.style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            return;
        }

        const questId = Number(questIdAttr);
        completeQuest(questId);

        activeScreen.style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
    });

    // Complete a quest (board or active). Custom quests give 5 coins; generated quests give 10.
    // Streak bonus applies: +10% per streak (rounded down).
    function completeQuest(questId) {
        const questCard = document.querySelector(`[data-quest-id="${questId}"]`);
        let questObj = null;
        let isCustom = false;

        if (questCard) {
            questCard.setAttribute('data-completed', 'true');
            const statusSpan = questCard.querySelector('.quest-status');
            const completeBtn = questCard.querySelector('.complete-btn');

            if (statusSpan) {
                statusSpan.className = 'quest-status completed';
                statusSpan.textContent = 'COMPLETED';
            }
            if (completeBtn) {
                completeBtn.disabled = true;
                completeBtn.textContent = '‚úì Completed';
            }

            if (questCard.getAttribute('data-custom') === 'true') {
                isCustom = true;
            }
        }

        // find quest object if possible
        if (!isCustom) {
            const found = currentQuests.find(q => Number(q.quest_id) === Number(questId));
            if (found) {
                questObj = found;
                if (found.category === 'custom') isCustom = true;
            }
        } else if (!questObj) {
            // If custom but not found in currentQuests (edge case), attempt to find in storage
            const customQuests = loadCustomQuestsFromStorage();
            const found = customQuests.find(q => Number(q.quest_id) === Number(questId));
            if (found) questObj = found;
        }

        // persist completion
        localStorage.setItem('quest_' + questId, 'completed');

        // Before awarding coins, update daily completions and possibly streak
        const streakUpdate = recordCompletionAndMaybeAwardStreak();
        // Load current streak (after any possible update)
        const streakData = loadStreakData();
        const currentStreak = streakData.currentStreak || 0;

        const base = (isCustom ? 5 : 10);
        const bonus = Math.floor(base * STREAK_BONUS_PERCENT_PER_STREAK * currentStreak);
        const coinsEarned = base + bonus;

        coins += coinsEarned;
        updateCoins();

        // Show celebration message with breakdown
        const celebration = document.createElement('div');
        celebration.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #4caf50; color: white; padding: 20px 30px; border-radius: 10px; font-size: 18px; z-index: 2000; text-align: center;';
        celebration.innerHTML = `üéâ Quest Completed!<br><span style="font-size:16px;">+${base} base coins${bonus > 0 ? ' +'+bonus+' streak bonus' : ''} = <strong>+'${coinsEarned} coins</strong></span>`;
        document.body.appendChild(celebration);

        setTimeout(() => { celebration.remove(); }, 2600);

        // update streak UI in header
        updateStreakUI();
    }

    // Load shop items
    function loadShop() {
        const shopData = window.questBoardAPI.getShopItems();
        renderShopItems(shopData.avatars, 'avatars-grid', 'avatar');
        renderShopItems(shopData.cosmetics, 'cosmetics-grid', 'cosmetic');
        renderCrateItems(shopData.vip_crates, 'crates-grid');
    }

    // Render VIP crate items
    function renderCrateItems(crates, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';

        crates.forEach(crate => {
            const crateDiv = document.createElement('div');
            crateDiv.className = 'shop-item';
            crateDiv.style.cursor = 'pointer';

            crateDiv.innerHTML = `
                <div class="shop-item-emoji">${crate.emoji}</div>
                <div class="shop-item-name">${crate.name}</div>
                <div style="font-size: 12px; color: #ff9800; margin: 5px 0;">VIP ${crate.vip_required}+ Required</div>
                <div class="shop-item-price">${crate.price} coins</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">${crate.description}</div>
                <button class="buy-btn" onclick="openCrate('${crate.id}', ${crate.price}, ${crate.vip_required})">Open Crate</button>
            `;

            container.appendChild(crateDiv);
        });
    }

    // Open a crate
    function openCrate(crateId, price, vipRequired) {
        const userVipLevel = parseInt(localStorage.getItem('vipLevel')) || 5;

        if (coins < price) {
            alert('Not enough coins! You need ' + price + ' coins to open this crate.');
            return;
        }

        coins -= price;
        updateCoins();
        localStorage.setItem('coins', coins);

        const result = window.questBoardAPI.openCrate(crateId, userVipLevel);

        if (result.error) {
            alert('Error: ' + result.error);
            coins += price;
            updateCoins();
            localStorage.setItem('coins', coins);
            return;
        }

        const reward = result.reward;
        const rewardDiv = document.createElement('div');
        rewardDiv.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 60px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            z-index: 2000;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            animation: bounce 0.5s ease;
        `;

        const rarityColors = {
            'common': '#9e9e9e',
            'uncommon': '#4caf50',
            'rare': '#2196f3',
            'epic': '#9c27b0',
            'legendary': '#ff9800',
            'mythic': '#f44336'
        };

        rewardDiv.innerHTML = `
            <div style="font-size: 64px; margin-bottom: 20px;">${reward.emoji}</div>
            <div style="font-size: 28px; margin-bottom: 10px;">${reward.item}</div>
            <div style="font-size: 16px; color: ${rarityColors[reward.rarity] || '#fff'}; text-transform: uppercase; letter-spacing: 2px;">
                ${reward.rarity || ''}
            </div>
            ${reward.type === 'points' ? `<div style="font-size: 20px; margin-top: 15px;">+${reward.value} coins üí∞</div>` : ''}
        `;

        document.body.appendChild(rewardDiv);

        const style = document.createElement('style');
        style.textContent = `
            @keyframes bounce {
                0%, 100% { transform: translate(-50%, -50%) scale(1); }
                50% { transform: translate(-50%, -50%) scale(1.1); }
            }
        `;
        document.head.appendChild(style);

        if (reward.type === 'points' && reward.value) {
            coins += reward.value;
            updateCoins();
            localStorage.setItem('coins', coins);
        }

        setTimeout(() => {
            rewardDiv.remove();
            style.remove();
        }, 3500);
    }

    // Render shop items (avatars/cosmetics)
    function renderShopItems(items, containerId, itemType) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';

        items.forEach(item => {
            const owned = ownedItems.includes(item.id);
            const equipped = (itemType === 'avatar' && equippedAvatar === item.emoji) ||
                            (item.type === 'title' && equippedTitle === item.emoji + ' ' + item.name);

            const itemDiv = document.createElement('div');
            itemDiv.className = 'shop-item' + (owned ? ' owned' : '') + (equipped ? ' equipped' : '');

            let buttonHTML = '';
            if (!owned) {
                buttonHTML = `<button class="buy-btn" onclick="buyItem('${item.id}', ${item.price}, '${itemType}')">Buy - ${item.price} üí∞</button>`;
            } else if (!equipped && (itemType === 'avatar' || item.type === 'title')) {
                buttonHTML = `<button class="equip-btn" onclick="equipItem('${item.id}', '${item.emoji}', '${item.name}', '${item.type}')">Equip</button>`;
            } else if (equipped) {
                buttonHTML = `<button class="equip-btn" disabled>Equipped ‚úì</button>`;
            } else {
                buttonHTML = `<button class="buy-btn" disabled>Owned ‚úì</button>`;
            }

            itemDiv.innerHTML = `
                <div class="shop-item-emoji">${item.emoji}</div>
                <div class="shop-item-name">${item.name}</div>
                <div class="shop-item-price">${owned ? 'Owned' : item.price + ' coins'}</div>
                ${buttonHTML}
            `;

            container.appendChild(itemDiv);
        });
    }

    // Buy item
    function buyItem(itemId, price, itemType) {
        if (coins >= price) {
            coins -= price;
            ownedItems.push(itemId);
            localStorage.setItem('coins', coins);
            localStorage.setItem('ownedItems', JSON.stringify(ownedItems));
            updateCoins();
            loadShop();

            const message = document.createElement('div');
            message.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #4caf50; color: white; padding: 20px 40px; border-radius: 10px; font-size: 20px; z-index: 2000; text-align: center;';
            message.textContent = '‚úì Purchase Successful!';
            document.body.appendChild(message);

            setTimeout(() => { message.remove(); }, 1500);
        } else {
            alert('Not enough coins! Complete more quests to earn coins.');
        }
    }

    // Buy QuestMaster (unavailable)
    function buyQuestMaster() {
        alert('currently unable to purchase, please try again next time');
        const btns = document.querySelectorAll('.shop-item .buy-btn');
        const qmButton = Array.from(btns).find(b => b && b.parentElement && b.parentElement.querySelector('.shop-item-name') && b.parentElement.querySelector('.shop-item-name').textContent === 'QuestMaster');
        if (qmButton) {
            qmButton.disabled = true;
            setTimeout(() => { qmButton.disabled = false; }, 2000);
        }
    }

    // Equip item
    function equipItem(itemId, emoji, name, type) {
        if (type === 'avatar') {
            equippedAvatar = emoji;
            localStorage.setItem('equippedAvatar', emoji);
        } else if (type === 'title') {
            equippedTitle = emoji + ' ' + name;
            localStorage.setItem('equippedTitle', equippedTitle);
        }
        updateProfile();
        loadShop();
    }

    // Quest generation logic
    const QUEST_TEMPLATES = {
        cardio: [
            { activity: "Run", units: "minutes", range: [10, 30] },
            { activity: "Walk", units: "minutes", range: [15, 45] },
            { activity: "Jump rope", units: "minutes", range: [5, 15] },
            { activity: "Cycling", units: "minutes", range: [15, 40] },
            { activity: "Swimming", units: "minutes", range: [10, 30] },
            { activity: "Dancing", units: "minutes", range: [15, 30] }
        ],
        strength: [
            { activity: "Push-ups", units: "reps", range: [10, 50] },
            { activity: "Squats", units: "reps", range: [15, 60] },
            { activity: "Lunges", units: "reps", range: [10, 40] },
            { activity: "Plank hold", units: "seconds", range: [30, 120] },
            { activity: "Wall sits", units: "seconds", range: [30, 90] },
            { activity: "Burpees", units: "reps", range: [10, 30] },
            { activity: "Mountain climbers", units: "reps", range: [20, 60] },
            { activity: "Sit-ups", units: "reps", range: [15, 50] },
            { activity: "Pull-ups", units: "reps", range: [5, 20] }
        ],
        flexibility: [
            { activity: "Yoga session", units: "minutes", range: [10, 30] },
            { activity: "Stretching routine", units: "minutes", range: [10, 20] },
            { activity: "Foam rolling", units: "minutes", range: [5, 15] }
        ],
        wellness: [
            { activity: "Drink water", units: "glasses", range: [6, 10] },
            { activity: "Meditate", units: "minutes", range: [5, 20] },
            { activity: "Sleep", units: "hours", range: [7, 9] },
            { activity: "Take deep breaths", units: "cycles", range: [5, 15] },
            { activity: "Go Outside and Touch Grass", units: "minutes", range: [10, 30] }
        ]
    };

    const SHOP_ITEMS = {
        avatars: [
            { id: "avatar_1", name: "Fitness Pro", emoji: "üèãÔ∏è", price: 50, type: "avatar" },
            { id: "avatar_2", name: "Yoga Master", emoji: "üßò", price: 50, type: "avatar" },
            { id: "avatar_3", name: "Runner", emoji: "üèÉ", price: 50, type: "avatar" },
            { id: "avatar_4", name: "Cyclist", emoji: "üö¥", price: 75, type: "avatar" },
            { id: "avatar_5", name: "Swimmer", emoji: "üèä", price: 75, type: "avatar" },
            { id: "avatar_6", name: "Champion", emoji: "üèÜ", price: 100, type: "avatar" },
            { id: "avatar_7", name: "Martial Artist", emoji: "ü•ã", price: 100, type: "avatar" },
            { id: "avatar_8", name: "Boxer", emoji: "ü•ä", price: 100, type: "avatar" }
        ],
        cosmetics: [
            { id: "border_1", name: "Gold Border", emoji: "‚ú®", price: 30, type: "border", color: "#ffd700" },
            { id: "border_2", name: "Silver Border", emoji: "‚≠ê", price: 20, type: "border", color: "#c0c0c0" },
            { id: "border_3", name: "Bronze Border", emoji: "üî∂", price: 10, type: "border", color: "#cd7f32" },
            { id: "border_4", name: "Rainbow Border", emoji: "üåà", price: 150, type: "border", color: "linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #8b00ff)" },
            { id: "title_1", name: "Beginner", emoji: "üå±", price: 5, type: "title" },
            { id: "title_2", name: "Warrior", emoji: "‚öîÔ∏è", price: 50, type: "title" },
            { id: "title_3", name: "Legend", emoji: "üëë", price: 100, type: "title" },
            { id: "title_4", name: "sigma", emoji: "üóø", price: 67410000, type: "title" }
        ],
        vip_crates: [
            { id: "bronze_crate", name: "Bronze VIP Crate", emoji: "üì¶", price: 100, type: "crate", vip_required: 1, description: "Basic VIP crate with common rewards" },
            { id: "silver_crate", name: "Silver VIP Crate", emoji: "üéÅ", price: 250, type: "crate", vip_required: 2, description: "Advanced VIP crate with uncommon and rare rewards" },
            { id: "gold_crate", name: "Gold VIP Crate", emoji: "üèÜ", price: 500, type: "crate", vip_required: 3, description: "Premium VIP crate with epic and legendary rewards" },
            { id: "platinum_crate", name: "Platinum VIP Crate", emoji: "üí´", price: 1000, type: "crate", vip_required: 5, description: "Ultimate VIP crate with guaranteed legendary rewards" }
        ]
    };

    const VIP_CRATES = {
        bronze_crate: {
            rewards: [
                { item: "Common Avatar", type: "avatar", emoji: "üë§", probability: 0.50, rarity: "common" },
                { item: "Basic Border", type: "border", emoji: "‚¨ú", probability: 0.30, rarity: "common" },
                { item: "50 Bonus Points", type: "points", emoji: "üí∞", value: 50, probability: 0.15, rarity: "uncommon" },
                { item: "Epic Title", type: "title", emoji: "üéØ", probability: 0.05, rarity: "rare" }
            ]
        },
        silver_crate: {
            rewards: [
                { item: "Rare Avatar", type: "avatar", emoji: "ü¶∏", probability: 0.40, rarity: "uncommon" },
                { item: "Premium Border", type: "border", emoji: "üî∑", probability: 0.30, rarity: "uncommon" },
                { item: "150 Bonus Points", type: "points", emoji: "üíé", value: 150, probability: 0.20, rarity: "rare" },
                { item: "Legendary Title", type: "title", emoji: "üëë", probability: 0.08, rarity: "epic" },
                { item: "Mystery Reward", type: "special", emoji: "‚ùì", probability: 0.02, rarity: "legendary" }
            ]
        },
        gold_crate: {
            rewards: [
                { item: "Epic Avatar", type: "avatar", emoji: "üåü", probability: 0.35, rarity: "rare" },
                { item: "Diamond Border", type: "border", emoji: "üí†", probability: 0.25, rarity: "epic" },
                { item: "300 Bonus Points", type: "points", emoji: "üî•", value: 300, probability: 0.20, rarity: "epic" },
                { item: "Ultimate Title", type: "title", emoji: "‚ö°", probability: 0.15, rarity: "epic" },
                { item: "Exclusive Avatar Pack", type: "avatar_pack", emoji: "üé≠", probability: 0.04, rarity: "legendary" },
                { item: "Jackpot 1000 Points", type: "points", emoji: "üí∏", value: 1000, probability: 0.01, rarity: "legendary" }
            ]
        },
        platinum_crate: {
            rewards: [
                { item: "Legendary Avatar", type: "avatar", emoji: "üî±", probability: 0.30, rarity: "legendary" },
                { item: "Cosmic Border", type: "border", emoji: "üåå", probability: 0.25, rarity: "legendary" },
                { item: "500 Bonus Points", type: "points", emoji: "üíµ", value: 500, probability: 0.20, rarity: "legendary" },
                { item: "Divine Title", type: "title", emoji: "‚ú®", probability: 0.15, rarity: "legendary" },
                { item: "Ultimate Pack", type: "ultimate_pack", emoji: "üé™", probability: 0.08, rarity: "mythic" },
                { item: "MEGA JACKPOT 5000 Points", type: "points", emoji: "üèÖ", value: 5000, probability: 0.02, rarity: "mythic" }
            ]
        }
    };

    function generateRandomQuests(count = 6, categoryFilter = 'all') {
        const quests = [];
        const categories = Object.keys(QUEST_TEMPLATES);
        const filter = (categoryFilter || 'all').toLowerCase();

        for (let i = 0; i < count; i++) {
            const category = (filter === 'all' || !QUEST_TEMPLATES[filter]) ? categories[Math.floor(Math.random() * categories.length)] : filter;
            const templates = QUEST_TEMPLATES[category];
            const template = templates[Math.floor(Math.random() * templates.length)];
            const amount = Math.floor(Math.random() * (template.range[1] - template.range[0] + 1)) + template.range[0];

            const questId = Date.now() + i + Math.floor(Math.random() * 1000);

            quests.push({
                quest_id: questId,
                title: `${template.activity} Challenge`,
                description: `Complete ${amount} ${template.units} of ${template.activity.toLowerCase()}`,
                category: category,
                status: "active"
            });
        }

        return quests;
    }

    function openCrate(crateId, userVipLevel) {
        if (!VIP_CRATES[crateId]) {
            return { error: "Invalid crate ID" };
        }

        const crate = VIP_CRATES[crateId];
        const rewards = crate.rewards;
        const randomValue = Math.random();
        let cumulativeProbability = 0.0;

        for (const reward of rewards) {
            cumulativeProbability += reward.probability;
            if (randomValue <= cumulativeProbability) {
                return { success: true, reward: reward, message: `You received: ${reward.emoji} ${reward.item}!` };
            }
        }

        return { success: true, reward: rewards[rewards.length - 1], message: `You received: ${rewards[rewards.length - 1].emoji} ${rewards[rewards.length - 1].item}!` };
    }

    window.questBoardAPI = { generateRandomQuests, getShopItems: () => SHOP_ITEMS, openCrate };

    // Refresh quests button: clear local quest completion markers and load new quests using selected filter
    document.getElementById('refresh-quests').addEventListener('click', function() {
        Object.keys(localStorage).forEach(key => {
            if (key.startsWith('quest_')) {
                localStorage.removeItem(key);
            }
        });
        loadQuests();
    });

    // When filter changes, reload quests
    const filterSelect = document.getElementById('quest-filter');
    if (filterSelect) {
        filterSelect.addEventListener('change', function() { loadQuests(); });
    }

    // Initialize UI
    updateCoins();
    updateProfile();
    updateStreakUI();
    loadQuests();
</script>

</body>
</html>
