<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quest Board</title>
    <script type="module" src="./questboard.js"></script>
    <style>
        .quest-board-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .quest-board-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .quest-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .quest-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .quest-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .quest-description {
            color: #666;
            margin-bottom: 10px;
        }

        .quest-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .quest-status.active {
            background: #4caf50;
            color: white;
        }

        .quest-status.pending {
            background: #ff9800;
            color: white;
        }

        .quest-status.completed {
            background: #2196f3;
            color: white;
        }

        .quest-category {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 10px;
            text-transform: uppercase;
        }

        .category-cardio {
            background: #e3f2fd;
            color: #1976d2;
        }

        .category-strength {
            background: #fce4ec;
            color: #c2185b;
        }

        .category-flexibility {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .category-wellness {
            background: #e8f5e9;
            color: #388e3c;
        }

        .category-custom {
            background: #eceff1;
            color: #37474f;
        }

        .complete-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .complete-btn:hover {
            background: #45a049;
        }

        .complete-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .start-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            margin-left: 10px;
            transition: background 0.3s;
        }

        .start-btn:hover {
            background: #1976d2;
        }

        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 8px;
        }

        .delete-btn:hover {
            background: #d32f2f;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .refresh-btn:hover {
            background: #5568d3;
        }

        .coin-display {
            background: #ffd700;
            color: #333;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 18px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .shop-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            margin-left: 10px;
        }

        .shop-btn:hover {
            background: #f57c00;
        }

        .terms-btn {
            background: #607d8b;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 8px;
            font-size: 14px;
        }

        .terms-btn:hover {
            background: #546e7a;
        }

        .shop-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .shop-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 15px;
        }

        .shop-close {
            font-size: 32px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }

        .shop-close:hover {
            color: #333;
        }

        .shop-section {
            margin-bottom: 30px;
        }

        .shop-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .shop-item {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .shop-item:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .shop-item.owned {
            border-color: #4caf50;
            background: #e8f5e9;
        }

        .shop-item.equipped {
            border-color: #ffd700;
            background: #fffde7;
        }

        .shop-item-emoji {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .shop-item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .shop-item-price {
            color: #ffd700;
            font-weight: bold;
            font-size: 16px;
        }

        .buy-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
        }

        .buy-btn:hover {
            background: #45a049;
        }

        .buy-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .equip-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
        }

        .equip-btn:hover {
            background: #1976d2;
        }

        .profile-avatar {
            font-size: 48px;
            margin-right: 10px;
        }

        .profile-title {
            color: #667eea;
            font-weight: bold;
            margin-left: 10px;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h2 {
            color: #667eea;
            margin: 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-login {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-login:hover {
            opacity: 0.9;
        }

        .signup-link {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }

        .signup-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
        }

        .signup-link a:hover {
            text-decoration: underline;
        }

        .error-message {
            color: #f44336;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        #main-content {
            display: none;
        }

        .quest-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .quest-filter {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 14px;
            background: white;
        }

        .quest-filter:focus {
            outline: none;
            border-color: #667eea;
        }

        .custom-quest-form {
            margin: 18px 0;
            padding: 12px;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .custom-quest-form input[type="text"] {
            flex: 1 1 240px;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 14px;
        }

        .custom-quest-form textarea {
            flex: 2 1 360px;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 14px;
            resize: vertical;
            min-height: 48px;
        }

        .add-custom-btn {
            background: #00bfa5;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .add-custom-btn:hover {
            background: #009e90;
        }

        .streak-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }

        .streak-badge {
            background: linear-gradient(90deg, #ff7043, #ffca28);
            color: white;
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: bold;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            position: relative;
            /* Anchor for tooltip */
            cursor: help;
        }

        /* Reveal tooltip on hover */
        .streak-badge:hover .streak-help {
            display: block;
            animation: fadeIn 0.2s;
        }

        .streak-help {
            display: none;
            /* Hidden by default */
            position: absolute;
            top: 100%;
            right: 0;
            width: 220px;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: normal;
            z-index: 100;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            text-align: left;
            line-height: 1.4;
        }

        /* caret for tooltip */
        .streak-help::before {
            content: "";
            position: absolute;
            top: -6px;
            right: 15px;
            border-width: 0 6px 6px 6px;
            border-style: solid;
            border-color: transparent transparent rgba(0, 0, 0, 0.9) transparent;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bg-preview {
            width: 100%;
            height: 70px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        /* Active quest full-screen view */
        #active-quest-screen {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 3000;
            align-items: center;
            justify-content: center;
            padding: 24px;
            color: white;
        }

        #active-quest-screen .active-quest-card {
            width: 100%;
            max-width: 800px;
            background: linear-gradient(135deg, #bdbdbd 0%, #667eea 100%);
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
            text-align: center;
            color: #fff;
        }

        #active-quest-screen .active-quest-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 12px;
        }

        #active-quest-screen .active-quest-description {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 28px;
        }

        #active-quest-screen .mark-complete-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-weight: 800;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.2s;
        }

        #active-quest-screen .mark-complete-btn:hover {
            background: #3f9a3f;
        }

        #active-quest-screen .cancel-quest-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            margin-left: 12px;
        }

        /* inspirational bubble inside active quest */
        .inspire-bubble {
            position: absolute;
            top: 18%;
            right: 6%;
            background: linear-gradient(90deg, #ff8a65, #ffb74d);
            color: white;
            padding: 10px 14px;
            border-radius: 999px;
            font-weight: 800;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
            transform: translateY(-6px) scale(.98);
            opacity: 0;
            transition: transform 260ms cubic-bezier(.2, .9, .2, 1), opacity 260ms ease;
            pointer-events: none;
            z-index: 3100;
        }

        .inspire-bubble.show {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        /* Terms modal */
        #terms-modal {
            display: none;
            position: fixed;
            z-index: 4000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        #terms-modal .terms-content {
            width: 100%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            background: white;
            border-radius: 12px;
            padding: 24px 28px;
            color: #222;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        #terms-modal .terms-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        #terms-modal .terms-header h2 {
            margin: 0;
            color: #333;
            font-size: 20px;
        }

        #terms-modal .terms-close {
            font-size: 24px;
            cursor: pointer;
            color: #666;
            border: none;
            background: none;
        }

        #terms-modal .terms-body {
            font-size: 14px;
            color: #333;
            line-height: 1.5;
        }

        #terms-modal .terms-body h3 {
            margin-top: 14px;
            color: #222;
        }

        #terms-modal .terms-footer {
            margin-top: 14px;
            text-align: right;
        }

        #terms-modal .terms-ok {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
        }

        @media (max-width:600px) {
            #active-quest-screen .active-quest-card {
                padding: 22px;
            }

            #active-quest-screen .active-quest-title {
                font-size: 22px;
            }

            #active-quest-screen .mark-complete-btn {
                width: 100%;
                display: block;
                margin-bottom: 8px;
            }

            #active-quest-screen .cancel-quest-btn {
                width: 100%;
                display: block;
                margin-top: 8px;
            }

            .custom-quest-form {
                flex-direction: column;
                align-items: stretch;
            }

            .streak-info {
                align-items: center;
            }

            #terms-modal .terms-content {
                padding: 16px;
            }

            .inspire-bubble {
                top: 10%;
                right: 6%;
                font-size: 14px;
                padding: 8px 12px;
            }
        }

        /* --- Login animation overlay (NEW) --- */
        #login-animation-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(rgba(0, 0, 0, 0.55), rgba(0, 0, 0, 0.45));
            z-index: 6000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 260ms ease;
        }

        #login-animation-overlay.show {
            pointer-events: auto;
            opacity: 1;
        }

        .login-animation-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 28px 32px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.45);
            transform: translateY(8px);
            animation: popIn 420ms cubic-bezier(.2, .9, .2, 1);
            min-width: 280px;
        }

        .login-animation-emoji {
            font-size: 48px;
            margin-bottom: 6px;
        }

        .login-animation-message {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .login-animation-sub {
            font-size: 14px;
            opacity: 0.95;
        }

        @keyframes popIn {
            from {
                transform: translateY(16px) scale(.96);
                opacity: 0;
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        /* confetti pieces */
        .login-confetti {
            position: absolute;
            bottom: 40%;
            width: 10px;
            height: 14px;
            border-radius: 2px;
            opacity: 0.95;
            transform: translateY(0) rotate(0deg);
            animation: confettiFloat var(--dur, 1200ms) cubic-bezier(.2, .8, .3, 1) forwards;
        }

        @keyframes confettiFloat {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }

            60% {
                transform: translateY(-90px) rotate(160deg);
                opacity: 1;
            }

            100% {
                transform: translateY(-220px) rotate(300deg);
                opacity: 0;
            }
        }

        /* --- Quest complete overlay (NEW) --- */
        .quest-complete-overlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.55);
            z-index: 6500;
            pointer-events: none;
            opacity: 0;
            transition: opacity 260ms ease;
        }

        .quest-complete-overlay.show {
            display: flex;
            pointer-events: auto;
            opacity: 1;
        }

        .qc-card {
            background: linear-gradient(135deg, #4caf50, #81c784);
            color: white;
            padding: 26px 34px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 14px 50px rgba(0, 0, 0, 0.45);
            transform: scale(.98);
            animation: qcPop 420ms cubic-bezier(.2, .9, .2, 1) forwards;
            min-width: 300px;
        }

        @keyframes qcPop {
            from {
                transform: scale(.92) translateY(8px);
                opacity: 0;
            }

            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .qc-title {
            font-size: 22px;
            font-weight: 900;
            margin-bottom: 8px;
        }

        .qc-sub {
            font-size: 15px;
            opacity: 0.95;
            margin-bottom: 12px;
        }

        .qc-coins {
            font-size: 20px;
            font-weight: 900;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }

        .qc-coin {
            background: #ffd700;
            color: #333;
            padding: 8px 12px;
            border-radius: 50px;
            font-weight: 900;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
            transform-origin: center;
            animation: coinPop 900ms cubic-bezier(.2, .9, .2, 1);
        }

        @keyframes coinPop {
            0% {
                transform: translateY(6px) scale(.8);
                opacity: 0;
            }

            40% {
                transform: translateY(-12px) scale(1.12);
                opacity: 1;
            }

            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        /* small confetti for qc overlay */
        .qc-confetti {
            position: absolute;
            width: 10px;
            height: 12px;
            border-radius: 2px;
            opacity: 0.95;
            animation: qcConfetti 1000ms cubic-bezier(.18, .8, .25, 1) forwards;
        }

        @keyframes qcConfetti {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }

            50% {
                transform: translateY(-120px) rotate(180deg);
                opacity: 1;
            }

            100% {
                transform: translateY(-260px) rotate(360deg);
                opacity: 0;
            }
        }

        /* reduced motion preference */
        @media (prefers-reduced-motion: reduce) {

            .login-confetti,
            .qc-confetti {
                animation-duration: 1ms !important;
                opacity: 0 !important;
            }

            .login-animation-card,
            .qc-card {
                animation: none !important;
                transform: none !important;
            }

            .inspire-bubble {
                transition: none !important;
                transform: none !important;
                opacity: 1 !important;
            }
        }
    </style>
</head>

<body>

    <!-- Login Page -->
    <div id="login-page">
        <div class="login-container">
            <div class="login-header">
                <h2>üéØ Quest Board Login</h2>
                <p style="color: #666; margin-top: 10px;">Sign in to view your quests</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required placeholder="Enter your username">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required placeholder="Enter your password">
                </div>
                <button type="submit" class="btn-login">Login</button>
                <div class="error-message" id="error-message"></div>
            </form>
            <div class="signup-link">Don't have an account? <a href="#" id="signup-link">Sign up</a></div>
        </div>
    </div>

    <!-- Main Quest Board (Hidden until login) -->
    <div id="main-content">
        <div class="quest-board-header">
            <h1 style="margin: 0; font-size: 32px;">üí™ Daily Health Quest Board</h1>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">Complete daily fitness and wellness challenges</p>
        </div>

        <div class="user-profile-details-style" style="padding: 15px; background: #f5f5f5;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center;">
                    <span class="profile-avatar" id="user-avatar">üë§</span>
                    <div>
                        <span id="user_status">Welcome, Adventurer!</span>
                        <span class="profile-title" id="user-title"></span>
                    </div>
                </div>
                <div style="display:flex; align-items:center; gap:12px;">
                    <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end;">
                        <div class="coin-display"><span>üí∞</span><span id="coin-count">0</span><span>coins</span></div>
                        <div id="streak-ui" class="streak-info" style="align-items:flex-end;"></div>
                    </div>
                    <div>
                        <button id="shop-btn" class="shop-btn">üõí Shop</button>
                        <button id="terms-btn" class="terms-btn">Terms &amp; Conditions</button>
                        <button id="logout-btn"
                            style="padding:8px 20px; background:#f44336; color:white; border:none; border-radius:5px; cursor:pointer;">Logout</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="quest-board-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h2 style="color:#333; margin:0;">Your Daily Health Quests</h2>
                <div class="quest-controls">
                    <select id="quest-filter" class="quest-filter" title="Filter quests by category">
                        <option value="all">All Quests</option>
                        <option value="cardio">Cardio</option>
                        <option value="strength">Strength</option>
                        <option value="flexibility">Flexibility</option>
                        <option value="wellness">Wellness</option>
                        <option value="custom">Custom</option>
                    </select>
                    <button id="refresh-quests" class="refresh-btn">üîÑ Get New Quests</button>
                </div>
            </div>

            <!-- Custom Quest Form -->
            <div class="custom-quest-form" id="custom-quest-form">
                <input id="custom-title" type="text" placeholder="Custom quest title (e.g. Evening Walk)" />
                <textarea id="custom-description" placeholder="Custom quest description (what to do)"></textarea>
                <button id="add-custom-quest" class="add-custom-btn">Add Custom Quest</button>
            </div>

            <div id="quest-list"><!-- Quests will be loaded here dynamically --></div>
        </div>
    </div>

    <!-- Active Quest Fullscreen View -->
    <div id="active-quest-screen" role="dialog" aria-modal="true">
        <div class="active-quest-card" role="document">
            <div class="active-quest-title">Quest Title</div>
            <div class="active-quest-description">Quest description goes here</div>
            <div>
                <button id="mark-complete-btn" class="mark-complete-btn">Mark Quest as Completed</button>
                <button id="cancel-quest-btn" class="cancel-quest-btn">Back to Board</button>
            </div>
        </div>

        <!-- inspirational bubble shown while quest is active -->
        <div id="inspire-bubble" class="inspire-bubble" role="status" aria-live="polite" aria-hidden="true"></div>
    </div>

    <!-- Quest complete overlay (created/used by JS) -->
    <div id="quest-complete-overlay" class="quest-complete-overlay" aria-hidden="true"></div>

    <!-- Shop Modal -->
    <div id="shop-modal" class="shop-modal" aria-hidden="true">
        <div class="shop-content" role="dialog" aria-modal="true">
            <div class="shop-header">
                <h2 style="margin: 0;">üõí Quest Shop</h2>
                <span class="shop-close" id="shop-close" role="button" aria-label="Close shop">&times;</span>
            </div>

            <div style="text-align:center; margin-bottom:30px;">
                <div class="coin-display" style="font-size:24px;"><span>üí∞</span><span
                        id="shop-coin-count">0</span><span>coins</span></div>
            </div>

            <!-- Special Offer -->
            <div class="shop-section">
                <h3>üî• Special Offer</h3>
                <div class="shop-items">
                    <div class="shop-item">
                        <div class="shop-item-emoji">üß≠</div>
                        <div class="shop-item-name">QuestMaster</div>
                        <div class="shop-item-price">$6.99</div>
                        <div style="font-size:12px; color:#666; margin-top:8px;">Unlock special QuestMaster features
                        </div>
                        <button class="buy-btn" onclick="buyQuestMaster()">Buy QuestMaster - $6.99</button>
                    </div>
                </div>
            </div>

            <!-- Backgrounds -->
            <div class="shop-section">
                <h3>üñºÔ∏è Backgrounds</h3>
                <div class="shop-items" id="backgrounds-grid"></div>
            </div>

            <div class="shop-section">
                <h3>üé≠ Avatars</h3>
                <div class="shop-items" id="avatars-grid"></div>
            </div>

            <div class="shop-section">
                <h3>‚ú® Cosmetics</h3>
                <div class="shop-items" id="cosmetics-grid"></div>
            </div>

            <div class="shop-section">
                <h3>üì¶ VIP Crates</h3>
                <p style="color:#666; font-size:14px; margin-bottom:15px;">Special crates with random rewards! VIP level
                    required to open.</p>
                <div class="shop-items" id="crates-grid"></div>
            </div>
        </div>
    </div>

    <!-- Terms & Conditions Modal -->
    <div id="terms-modal" role="dialog" aria-modal="true">
        <div class="terms-content" role="document" aria-labelledby="terms-title">
            <div class="terms-header">
                <h2 id="terms-title">Terms and Conditions</h2>
                <button class="terms-close" id="terms-close" aria-label="Close terms">&times;</button>
            </div>
            <div class="terms-body">
                <h3>Introduction</h3>
                <p>Welcome to QuestBoard! QuestBoard (‚Äúthe App‚Äù) is a health application designed to help users build
                    healthy habits through fun, RPG-style gamification. By accessing or using QuestBoard you agree to
                    these terms.</p>

                <h3>User Eligibility</h3>
                <p>QuestBoard is intended for individuals aged 13 and older. Users under 18 must have parental consent
                    to register and use the App.</p>

                <h3>App Purpose</h3>
                <p>QuestBoard is a health app with game elements, encouraging users to form and sustain healthy habits
                    through quests, coins, and social/group features.</p>

                <h3>Acceptable Use</h3>
                <p>Users must not use the App for unlawful or abusive purposes.</p>
                <p>Health tracking features are intended only for personal wellness; the App is not a substitute for
                    professional medical advice.</p>
                <p>Users are responsible for the information they enter and share, especially in social/group quests.
                </p>

                <h3>User-Generated Content</h3>
                <p>Quests, avatars, and social interactions rely on user input.</p>
                <p>Users retain rights to their original content but grant QuestBoard a license to use, display, and
                    adapt content within the App.</p>

                <h3>In-App Purchases</h3>
                <p>Coins earned in-game can unlock cosmetics. Some features may offer optional purchases.</p>
                <p>All payments are final unless specified otherwise. Refunds are subject to App Store or provider
                    policies.</p>

                <h3>Privacy and Data</h3>
                <p>QuestBoard collects wellness and activity data for app functionality, including planned device
                    integrations.</p>
                <p>Data is stored securely and used to enhance user experience.</p>
                <p>Personal and health information is never sold to third parties. Review our Privacy Policy for full
                    details.</p>

                <h3>Social Feature and Beta Testing</h3>
                <p>Group quests are available in beta. Features may change, and beta users accept possible instability,
                    bugs, and incomplete functionality.</p>

                <h3>Intellectual Property</h3>
                <p>All app code, graphics, and branding are owned by QuestBoard. Users must not copy or distribute App
                    materials.</p>

                <h3>Termination and Suspension</h3>
                <p>Accounts may be suspended or terminated for violations of these terms or for misuse or abuse of the
                    app.</p>

                <h3>Limitation of Liability</h3>
                <p>QuestBoard is not responsible for loss, injury, or failure to achieve specific health outcomes.</p>
                <p>The App is provided ‚Äúas is‚Äù without any warranties or guarantees.</p>

                <h3>Changes to Terms</h3>
                <p>QuestBoard reserves the right to update these terms. Users will be notified of significant changes
                    within the App.</p>

                <div class="terms-footer">
                    <button id="terms-ok" class="terms-ok">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login animation overlay (NEW) -->
    <div id="login-animation-overlay" aria-hidden="true">
        <div class="login-animation-card" role="status" aria-live="polite">
            <div class="login-animation-emoji">üéâ</div>
            <div class="login-animation-message">Welcome, <span id="login-username">Adventurer</span>!</div>
            <div class="login-animation-sub">Loading your Quest Board‚Ä¶</div>
        </div>
    </div>

    <script>
        // Global state & keys
        let coins = parseInt(localStorage.getItem('coins')) || 0;
        let ownedItems = JSON.parse(localStorage.getItem('ownedItems')) || [];
        let equippedAvatar = localStorage.getItem('equippedAvatar') || 'üë§';
        let equippedTitle = localStorage.getItem('equippedTitle') || '';
        let equippedBackground = localStorage.getItem('equippedBackground') || null;
        let currentQuests = [];

        const CUSTOM_QUESTS_KEY = 'customQuests_v1';
        const DAILY_COMPLETIONS_KEY = 'dailyCompletions_v1';
        const STREAK_DATA_KEY = 'streakData_v1';

        const STREAK_REQUIREMENT = 3;
        const STREAK_BONUS_PERCENT_PER_STREAK = 0.10;

        // Background styles mapping
        const BG_STYLES = {
            bg_light_blue: '#1e90ff', // light blue
            bg_pink: '#ff6ec7', // pink
            bg_light_gray: '#bebdb8', // light gray
            bg_blue_gray_grad: 'linear-gradient(135deg,#1e90ff,#bebdb8)', // light blue + light gray
            bg_pink_gray_grad: 'linear-gradient(135deg,#ff6ec7,#bebdb8)', // pink + light gray
            bg_blue_pink_grad: 'linear-gradient(135deg,#1e90ff,#ff6ec7)' // light blue + pink
        };

        // Shop items
        const SHOP_ITEMS = {
            backgrounds: [
                { id: "bg_light_blue", name: "Light Blue", emoji: "üü¶", price: 20, type: "background" },
                { id: "bg_pink", name: "Pink", emoji: "üü•", price: 20, type: "background" },
                { id: "bg_light_gray", name: "Light Gray", emoji: "‚¨ú", price: 15, type: "background" },
                { id: "bg_blue_gray_grad", name: "Light Blue ‚Üí Light Gray", emoji: "üé®", price: 30, type: "background" },
                { id: "bg_pink_gray_grad", name: "Pink ‚Üí Light Gray", emoji: "üé®", price: 30, type: "background" },
                { id: "bg_blue_pink_grad", name: "Light Blue ‚Üí Pink", emoji: "üé®", price: 30, type: "background" }
            ],
            avatars: [
                { id: "avatar_1", name: "Fitness Pro", emoji: "üèãÔ∏è", price: 50, type: "avatar" },
                { id: "avatar_2", name: "Yoga Master", emoji: "üßò", price: 50, type: "avatar" },
                { id: "avatar_3", name: "Runner", emoji: "üèÉ", price: 50, type: "avatar" },
                { id: "avatar_4", name: "Cyclist", emoji: "üö¥", price: 75, type: "avatar" },
                { id: "avatar_5", name: "Swimmer", emoji: "üèä", price: 75, type: "avatar" },
                { id: "avatar_6", name: "Champion", emoji: "üèÜ", price: 100, type: "avatar" },
                { id: "avatar_7", name: "Martial Artist", emoji: "ü•ã", price: 100, type: "avatar" },
                { id: "avatar_8", name: "Boxer", emoji: "ü•ä", price: 100, type: "avatar" }
            ],
            cosmetics: [
                { id: "border_1", name: "Gold Border", emoji: "‚ú®", price: 30, type: "border", color: "#ffd700" },
                { id: "border_2", name: "Silver Border", emoji: "‚≠ê", price: 20, type: "border", color: "#c0c0c0" },
                { id: "border_3", name: "Bronze Border", emoji: "üî∂", price: 10, type: "border", color: "#cd7f32" },
                { id: "border_4", name: "Rainbow Border", emoji: "üåà", price: 150, type: "border", color: "linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #8b00ff)" },
                { id: "title_1", name: "Beginner", emoji: "üå±", price: 5, type: "title" },
                { id: "title_2", name: "Warrior", emoji: "‚öîÔ∏è", price: 50, type: "title" },
                { id: "title_3", name: "Legend", emoji: "üëë", price: 100, type: "title" },
                { id: "title_4", name: "sigma", emoji: "üóø", price: 67410000, type: "title" }
            ],
            vip_crates: [
                { id: "bronze_crate", name: "Bronze VIP Crate", emoji: "üì¶", price: 100, type: "crate", vip_required: 1, description: "Basic VIP crate with common rewards" },
                { id: "silver_crate", name: "Silver VIP Crate", emoji: "üéÅ", price: 250, type: "crate", vip_required: 2, description: "Advanced VIP crate with uncommon and rare rewards" },
                { id: "gold_crate", name: "Gold VIP Crate", emoji: "üèÜ", price: 500, type: "crate", vip_required: 3, description: "Premium VIP crate with epic and legendary rewards" },
                { id: "platinum_crate", name: "Platinum VIP Crate", emoji: "üí´", price: 1000, type: "crate", vip_required: 5, description: "Ultimate VIP crate with guaranteed legendary rewards" }
            ]
        };

        // Utility: date string YYYY-MM-DD
        function todayStr(offsetDays = 0) {
            const d = new Date();
            d.setDate(d.getDate() + offsetDays);
            return d.toISOString().slice(0, 10);
        }

        // Persistence helpers
        function loadCustomQuestsFromStorage() {
            try { const raw = localStorage.getItem(CUSTOM_QUESTS_KEY); return raw ? JSON.parse(raw) : []; }
            catch (e) { console.error('parse custom', e); return []; }
        }
        function saveCustomQuestsToStorage(arr) { localStorage.setItem(CUSTOM_QUESTS_KEY, JSON.stringify(arr)); }

        function loadDailyCompletions() {
            try { const raw = localStorage.getItem(DAILY_COMPLETIONS_KEY); return raw ? JSON.parse(raw) : {}; }
            catch (e) { console.error(e); return {}; }
        }
        function saveDailyCompletions(obj) { localStorage.setItem(DAILY_COMPLETIONS_KEY, JSON.stringify(obj)); }

        function loadStreakData() {
            try { const raw = localStorage.getItem(STREAK_DATA_KEY); return raw ? JSON.parse(raw) : { currentStreak: 0, bestStreak: 0, lastStreakDate: null }; }
            catch (e) { console.error(e); return { currentStreak: 0, bestStreak: 0, lastStreakDate: null }; }
        }
        function saveStreakData(obj) { localStorage.setItem(STREAK_DATA_KEY, JSON.stringify(obj)); }

        // UI helpers
        function showMessage(text, ms = 2200) {
            const message = document.createElement('div');
            message.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.85);color:white;padding:16px 22px;border-radius:10px;z-index:9999;text-align:center;font-weight:700;';
            message.innerHTML = text;
            document.body.appendChild(message);
            setTimeout(() => message.remove(), ms);
        }

        // Background apply
        function applyBackground(id) {
            if (!id) {
                document.body.style.background = '';
                document.body.style.backgroundColor = '';
                return;
            }
            const style = BG_STYLES[id];
            if (!style) return;
            document.body.style.background = style;
            if (!style.includes('gradient')) {
                document.body.style.backgroundColor = style;
            }
        }

        // Streak UI
        function updateStreakUI() {
            const streakUi = document.getElementById('streak-ui');
            const streakData = loadStreakData();
            streakUi.innerHTML = '';
            const badge = document.createElement('div');
            badge.className = 'streak-badge';
            badge.innerHTML = `üî• Streak: <span id="streak-count">${streakData.currentStreak}</span>`;

            const help = document.createElement('div');
            help.className = 'streak-help';
            help.innerHTML = `Complete ${STREAK_REQUIREMENT} quests every day to build streaks ‚Äî each streak gives +${Math.round(STREAK_BONUS_PERCENT_PER_STREAK * 100)}% coins per quest.<br><br>Best Streak: <strong id="best-streak">${streakData.bestStreak}</strong>`;

            badge.appendChild(help); // Nest help inside badge
            streakUi.appendChild(badge);
        }

        // Daily completion & streak logic
        function incrementDailyCompletionFor(dateStr) {
            const daily = loadDailyCompletions();
            const prev = daily[dateStr] || 0;
            daily[dateStr] = prev + 1;
            saveDailyCompletions(daily);
            return { count: daily[dateStr], reachedNow: (prev < STREAK_REQUIREMENT && daily[dateStr] >= STREAK_REQUIREMENT) };
        }

        function checkAndUpdateStreakFor(dateStr) {
            const streakData = loadStreakData();
            if (streakData.lastStreakDate === dateStr) return streakData;
            const yesterday = todayStr(-1);
            if (streakData.lastStreakDate === yesterday) streakData.currentStreak = (streakData.currentStreak || 0) + 1;
            else streakData.currentStreak = 1;
            streakData.lastStreakDate = dateStr;
            if (!streakData.bestStreak || streakData.currentStreak > streakData.bestStreak) streakData.bestStreak = streakData.currentStreak;
            saveStreakData(streakData);
            updateStreakUI();
            return streakData;
        }

        function recordCompletionAndMaybeAwardStreak() {
            const date = todayStr();
            const res = incrementDailyCompletionFor(date);
            if (res.reachedNow) {
                const streakData = checkAndUpdateStreakFor(date);
                showMessage(`üéâ You completed ${STREAK_REQUIREMENT} quests today! Streak is now ${streakData.currentStreak}. +${Math.round(STREAK_BONUS_PERCENT_PER_STREAK * 100)}% coins per quest.`);
                return streakData;
            }
            return null;
        }

        // Update coin/profile
        function updateCoins() {
            const coinElem = document.getElementById('coin-count'); if (coinElem) coinElem.textContent = coins;
            const shopCoin = document.getElementById('shop-coin-count'); if (shopCoin) shopCoin.textContent = coins;
            localStorage.setItem('coins', coins);
        }
        function updateProfile() {
            const avatarElem = document.getElementById('user-avatar'); if (avatarElem) avatarElem.textContent = equippedAvatar;
            const titleElem = document.getElementById('user-title'); if (titleElem) titleElem.textContent = equippedTitle;
        }

        // API is loaded from main.js

        // Login
        document.getElementById('loginForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('error-message');
            if (username && password) {
                // Play the login animation and only reveal the main UI when it's done
                showLoginAnimation(username, function () {
                    document.getElementById('login-page').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    document.getElementById('user_status').textContent = 'Welcome, ' + username + '!';
                    updateCoins();
                    updateProfile();
                    updateStreakUI();
                    applyBackground(equippedBackground);
                    loadQuests();
                });
            } else { errorMessage.textContent = 'Please enter both username and password'; }
        });

        document.getElementById('logout-btn').addEventListener('click', function () {
            document.getElementById('login-page').style.display = 'block';
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('error-message').textContent = '';
        });

        document.getElementById('signup-link').addEventListener('click', function (e) { e.preventDefault(); alert('Signup functionality coming soon!'); });

        // Shop modal
        document.getElementById('shop-btn').addEventListener('click', function () { document.getElementById('shop-modal').style.display = 'block'; loadShop(); });
        document.getElementById('shop-close').addEventListener('click', function () { document.getElementById('shop-modal').style.display = 'none'; });
        window.addEventListener('click', function (event) { if (event.target == document.getElementById('shop-modal')) document.getElementById('shop-modal').style.display = 'none'; });

        // Terms modal open/close
        document.getElementById('terms-btn').addEventListener('click', function () {
            document.getElementById('terms-modal').style.display = 'flex';
            // focus for accessibility
            document.getElementById('terms-close').focus();
        });
        document.getElementById('terms-close').addEventListener('click', function () {
            document.getElementById('terms-modal').style.display = 'none';
        });
        document.getElementById('terms-ok').addEventListener('click', function () {
            document.getElementById('terms-modal').style.display = 'none';
        });
        // Close terms modal when clicking outside content
        window.addEventListener('click', function (event) {
            const tm = document.getElementById('terms-modal');
            if (!tm) return;
            if (event.target === tm) {
                tm.style.display = 'none';
            }
        });

        // Add custom quest
        document.getElementById('add-custom-quest').addEventListener('click', function () {
            const titleInput = document.getElementById('custom-title');
            const descInput = document.getElementById('custom-description');
            const title = (titleInput.value || '').trim();
            const description = (descInput.value || '').trim();
            if (!title) { alert('Please enter a title for the custom quest.'); return; }
            if (!description) { alert('Please enter a description for the custom quest.'); return; }
            const customQuests = loadCustomQuestsFromStorage();
            const questId = 'custom_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            const newQuest = { quest_id: questId, title, description, category: 'custom', status: 'active', custom: true };
            customQuests.push(newQuest);
            saveCustomQuestsToStorage(customQuests);
            titleInput.value = ''; descInput.value = '';
            loadQuests();
        });

        // Delete custom quest
        function deleteCustomQuest(questId) {
            if (!confirm('Delete this custom quest? This cannot be undone.')) return;
            const customQuests = loadCustomQuestsFromStorage();
            const filtered = customQuests.filter(q => String(q.quest_id) !== String(questId));
            saveCustomQuestsToStorage(filtered);
            try { localStorage.removeItem('quest_' + questId); } catch (e) { }
            showMessage('Custom quest deleted');
            loadQuests();
        }
        window.deleteCustomQuest = deleteCustomQuest;

        // Load quests
        function loadQuests() {
            const questList = document.getElementById('quest-list');
            questList.innerHTML = '<p style="text-align:center;color:#666">Loading quests...</p>';
            const filter = document.getElementById('quest-filter') ? document.getElementById('quest-filter').value : 'all';
            const generatedQuests = window.questBoardAPI.generateRandomQuests(6, filter === 'all' ? 'all' : filter);
            const customQuests = loadCustomQuestsFromStorage();
            let questsToShow = [];
            if (filter === 'custom') questsToShow = customQuests.slice();
            else if (filter === 'all') questsToShow = generatedQuests.concat(customQuests);
            else questsToShow = generatedQuests.filter(q => q.category === filter);

            currentQuests = questsToShow;
            questList.innerHTML = '';
            if (questsToShow.length === 0) { questList.innerHTML = '<p style="text-align:center;color:#666">No quests available for the selected category.</p>'; return; }

            questsToShow.forEach(quest => {
                const questCard = document.createElement('div');
                questCard.className = 'quest-card';
                questCard.setAttribute('data-quest-id', quest.quest_id);
                if (quest.category === 'custom') questCard.setAttribute('data-custom', 'true');
                const isCompleted = localStorage.getItem('quest_' + quest.quest_id) === 'completed';
                questCard.innerHTML = `
                <div>
                    <span class="quest-category category-${quest.category}">${quest.category}</span>
                    <span class="quest-status ${isCompleted ? 'completed' : quest.status}">
                        ${isCompleted ? 'COMPLETED' : quest.status.toUpperCase()}
                    </span>
                </div>
                <div class="quest-title">${escapeHtml(quest.title)}</div>
                <div class="quest-description">${escapeHtml(quest.description)}</div>
                <div>
                    <button class="complete-btn" onclick="completeQuest('${quest.quest_id}')" ${isCompleted ? 'disabled' : ''}>
                        ${isCompleted ? '‚úì Completed' : 'Mark as Complete'}
                    </button>
                    <button class="start-btn" onclick="startQuest('${quest.quest_id}')">‚ñ∂ Start</button>
                    ${quest.category === 'custom' ? `<button class="delete-btn" onclick="deleteCustomQuest('${quest.quest_id}')">Delete</button>` : ''}
                </div>
            `;
                questList.appendChild(questCard);
            });
        }

        document.getElementById('refresh-quests').addEventListener('click', function () { loadQuests(); });

        document.getElementById('quest-filter').addEventListener('change', function () { loadQuests(); });

        // Escape HTML for user input
        function escapeHtml(text) {
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // Inspirational phrases logic
        const INSPIRATIONAL_PHRASES = [
            "You got this!",
            "Keep going!",
            "Almost there!",
            "Stay strong!",
            "Nice work!",
            "One step at a time!"
        ];

        function startInspirationalPhrases() {
            const bubble = document.getElementById('inspire-bubble');
            if (!bubble) return;
            // clear any existing
            stopInspirationalPhrases();

            let idx = 0;
            bubble.textContent = INSPIRATIONAL_PHRASES[idx];
            bubble.setAttribute('aria-hidden', 'false');
            bubble.classList.add('show');

            // cycle phrases every ~1.8s with a small fade
            window._inspireInterval = setInterval(() => {
                bubble.classList.remove('show');
                // small fade duration to match CSS
                setTimeout(() => {
                    idx = (idx + 1) % INSPIRATIONAL_PHRASES.length;
                    bubble.textContent = INSPIRATIONAL_PHRASES[idx];
                    bubble.classList.add('show');
                }, 300);
            }, 1800);
        }

        function stopInspirationalPhrases() {
            const bubble = document.getElementById('inspire-bubble');
            if (window._inspireInterval) {
                clearInterval(window._inspireInterval);
                delete window._inspireInterval;
            }
            if (bubble) {
                bubble.classList.remove('show');
                bubble.setAttribute('aria-hidden', 'true');
                // clear text after a short delay so fade-out looks natural
                setTimeout(() => { if (bubble) bubble.textContent = ''; }, 300);
            }
        }

        // Active quest screen
        function startQuest(questId) {
            const quest = currentQuests.find(q => String(q.quest_id) === String(questId));
            const activeScreen = document.getElementById('active-quest-screen');
            if (!activeScreen) return;
            const titleEl = activeScreen.querySelector('.active-quest-title');
            const descEl = activeScreen.querySelector('.active-quest-description');
            if (quest) { if (titleEl) titleEl.textContent = quest.title; if (descEl) descEl.textContent = quest.description; }
            else { if (titleEl) titleEl.textContent = 'Active Quest'; if (descEl) descEl.textContent = 'Complete this quest and mark it as completed when finished.'; }
            activeScreen.setAttribute('data-active-quest-id', questId);
            document.getElementById('main-content').style.display = 'none';
            activeScreen.style.display = 'flex';
            const btn = document.getElementById('mark-complete-btn'); if (btn) btn.focus();

            // start inspirational phrases while the quest is active
            startInspirationalPhrases();
        }
        window.startQuest = startQuest;

        document.getElementById('cancel-quest-btn').addEventListener('click', function () {
            const activeScreen = document.getElementById('active-quest-screen');
            activeScreen.style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            // stop inspirational phrases when user returns to board
            stopInspirationalPhrases();
        });

        // Mark active quest completed ‚Äî updated to show animation when finished via "Start"
        document.getElementById('mark-complete-btn').addEventListener('click', function () {
            const activeScreen = document.getElementById('active-quest-screen');
            const questIdAttr = activeScreen.getAttribute('data-active-quest-id');
            if (!questIdAttr) { activeScreen.style.display = 'none'; document.getElementById('main-content').style.display = 'block'; return; }
            const questId = questIdAttr;

            // stop inspirational phrases first
            stopInspirationalPhrases();

            // show an animated celebration, then complete the quest and return to board
            showQuestCompleteAnimation(questId, function () {
                // hide active screen and return to main board
                activeScreen.style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            });
        });

        // Complete quest (handles custom coin amount + streak bonus)
        function completeQuest(questId) {
            // stop phrases if still running (covers direct completions)
            stopInspirationalPhrases();

            const questCard = document.querySelector(`[data-quest-id="${questId}"]`);
            let isCustom = false;
            if (questCard) {
                questCard.setAttribute('data-completed', 'true');
                const statusSpan = questCard.querySelector('.quest-status');
                const completeBtn = questCard.querySelector('.complete-btn');
                if (statusSpan) { statusSpan.className = 'quest-status completed'; statusSpan.textContent = 'COMPLETED'; }
                if (completeBtn) { completeBtn.disabled = true; completeBtn.textContent = '‚úì Completed'; }
                if (questCard.getAttribute('data-custom') === 'true') isCustom = true;
            }
            if (!isCustom) {
                const found = currentQuests.find(q => String(q.quest_id) === String(questId));
                if (found && found.category === 'custom') isCustom = true;
                else if (!found) {
                    const customQuests = loadCustomQuestsFromStorage();
                    if (customQuests.find(q => String(q.quest_id) === String(questId))) isCustom = true;
                }
            }
            localStorage.setItem('quest_' + questId, 'completed');

            // record daily completions & streaks
            const streakUpdate = recordCompletionAndMaybeAwardStreak();
            const streakData = loadStreakData();
            const currentStreak = streakData.currentStreak || 0;

            const base = isCustom ? 5 : 10;
            const bonus = Math.floor(base * STREAK_BONUS_PERCENT_PER_STREAK * currentStreak);
            const coinsEarned = base + bonus;
            coins += coinsEarned;
            updateCoins();

            // celebration with breakdown ‚Äî shown only when not suppressed by an external animation
            if (!window.QUIET_COMPLETE) {
                const celebration = document.createElement('div');
                celebration.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#4caf50;color:white;padding:20px 30px;border-radius:10px;font-size:18px;z-index:2000;text-align:center;font-weight:700;';
                celebration.innerHTML = `üéâ Quest Completed!<br><span style="font-size:16px;">+${base} base coins${bonus > 0 ? (' +' + bonus + ' streak bonus') : ''} = <strong>+${coinsEarned} coins</strong></span>`;
                document.body.appendChild(celebration);
                setTimeout(() => celebration.remove(), 2600);
            }

            updateStreakUI();
            return coinsEarned;
        }
        window.completeQuest = completeQuest;

        // Shop rendering & actions
        function loadShop() {
            const shopData = window.questBoardAPI.getShopItems();
            renderBackgroundItems(shopData.backgrounds, 'backgrounds-grid');
            renderShopItems(shopData.avatars, 'avatars-grid', 'avatar');
            renderShopItems(shopData.cosmetics, 'cosmetics-grid', 'cosmetic');
            renderCrateItems(shopData.vip_crates, 'crates-grid');
            updateCoins();
        }

        function renderBackgroundItems(items, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            items.forEach(item => {
                const owned = ownedItems.includes(item.id);
                const equipped = (equippedBackground === item.id);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item' + (owned ? ' owned' : '') + (equipped ? ' equipped' : '');
                const previewStyle = BG_STYLES[item.id] || '#fff';
                itemDiv.innerHTML = `
                <div class="bg-preview" style="background: ${previewStyle};"></div>
                <div class="shop-item-name">${item.name}</div>
                <div class="shop-item-price">${owned ? 'Owned' : item.price + ' coins'}</div>
                ${!owned ? `<button class="buy-btn" onclick="buyItem('${item.id}', ${item.price}, 'background')">Buy - ${item.price} üí∞</button>` :
                        (equipped ? `<button class="equip-btn" disabled>Equipped ‚úì</button>` : `<button class="equip-btn" onclick="equipBackground('${item.id}')">Equip</button>`)
                    }
            `;
                container.appendChild(itemDiv);
            });
        }

        function equipBackground(itemId) {
            equippedBackground = itemId;
            localStorage.setItem('equippedBackground', itemId);
            applyBackground(itemId);
            loadShop();
            showMessage('Background equipped');
        }
        window.equipBackground = equipBackground;

        function renderShopItems(items, containerId, itemType) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            items.forEach(item => {
                const owned = ownedItems.includes(item.id);
                const equipped = (itemType === 'avatar' && equippedAvatar === item.emoji) ||
                    (item.type === 'title' && equippedTitle === item.emoji + ' ' + item.name);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item' + (owned ? ' owned' : '') + (equipped ? ' equipped' : '');
                let buttonHTML = '';
                if (!owned) buttonHTML = `<button class="buy-btn" onclick="buyItem('${item.id}', ${item.price}, '${itemType}')">Buy - ${item.price} üí∞</button>`;
                else if (!equipped && (itemType === 'avatar' || item.type === 'title')) buttonHTML = `<button class="equip-btn" onclick="equipItem('${item.id}', '${item.emoji}', '${item.name}', '${item.type}')">Equip</button>`;
                else if (equipped) buttonHTML = `<button class="equip-btn" disabled>Equipped ‚úì</button>`;
                else buttonHTML = `<button class="buy-btn" disabled>Owned ‚úì</button>`;
                itemDiv.innerHTML = `
                <div class="shop-item-emoji">${item.emoji}</div>
                <div class="shop-item-name">${item.name}</div>
                <div class="shop-item-price">${owned ? 'Owned' : item.price + ' coins'}</div>
                ${buttonHTML}
            `;
                container.appendChild(itemDiv);
            });
        }

        function renderCrateItems(crates, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            crates.forEach(crate => {
                const crateDiv = document.createElement('div');
                crateDiv.className = 'shop-item';
                crateDiv.style.cursor = 'pointer';
                crateDiv.innerHTML = `
                <div class="shop-item-emoji">${crate.emoji}</div>
                <div class="shop-item-name">${crate.name}</div>
                <div style="font-size:12px;color:#ff9800;margin:5px 0;">VIP ${crate.vip_required}+ Required</div>
                <div class="shop-item-price">${crate.price} coins</div>
                <div style="font-size:11px;color:#666;margin-top:5px;">${crate.description}</div>
                <button class="buy-btn" onclick="openCrate('${crate.id}', ${crate.price}, ${crate.vip_required})">Open Crate</button>
            `;
                container.appendChild(crateDiv);
            });
        }

        function buyItem(itemId, price, itemType) {
            if (coins >= price) {
                coins -= price;
                if (!ownedItems.includes(itemId)) ownedItems.push(itemId);
                localStorage.setItem('coins', coins);
                localStorage.setItem('ownedItems', JSON.stringify(ownedItems));
                updateCoins();
                loadShop();
                const message = document.createElement('div');
                message.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#4caf50;color:white;padding:20px 40px;border-radius:10px;font-size:20px;z-index:2000;text-align:center;font-weight:700;';
                message.textContent = '‚úì Purchase Successful!';
                document.body.appendChild(message);
                setTimeout(() => message.remove(), 1500);
            } else { alert('Not enough coins! Complete more quests to earn coins.'); }
        }
        window.buyItem = buyItem;

        function equipItem(itemId, emoji, name, type) {
            if (type === 'avatar') {
                equippedAvatar = emoji;
                localStorage.setItem('equippedAvatar', equippedAvatar);
            } else if (type === 'title') {
                equippedTitle = emoji + ' ' + name;
                localStorage.setItem('equippedTitle', equippedTitle);
            }
            updateProfile();
            loadShop();
            showMessage('Item equipped');
        }
        window.equipItem = equipItem;

        function openCrate(crateId, price, vipRequired) {
            if (coins < price) { alert('Not enough coins to open this crate.'); return; }
            coins -= price;
            updateCoins();
            // simple random reward simulation
            const rewards = ["avatar_1", "border_1", "title_1", "avatar_3"];
            const reward = rewards[Math.floor(Math.random() * rewards.length)];
            if (!ownedItems.includes(reward)) ownedItems.push(reward);
            localStorage.setItem('ownedItems', JSON.stringify(ownedItems));
            loadShop();
            showMessage('üéÅ Crate opened! You received: ' + reward);
        }
        window.openCrate = openCrate;

        function buyQuestMaster() {
            alert('QuestMaster is currently unavailable in this demo.');
        }

        // --- Login animation functions (NEW) ---
        function showLoginAnimation(username, cb) {
            const overlay = document.getElementById('login-animation-overlay');
            if (!overlay) {
                if (typeof cb === 'function') cb();
                return;
            }
            // set username in welcome message
            const nameEl = document.getElementById('login-username');
            if (nameEl) nameEl.textContent = username;

            overlay.classList.add('show');

            // create confetti pieces
            const colors = ['#ffd700', '#ff6b6b', '#6bf0c4', '#8e9bff', '#ffd9a8'];
            const pieces = 22;
            const created = [];
            for (let i = 0; i < pieces; i++) {
                const c = document.createElement('div');
                c.className = 'login-confetti';
                const left = Math.random() * 80 + 10; // 10% - 90%
                c.style.left = left + '%';
                c.style.background = colors[Math.floor(Math.random() * colors.length)];
                c.style.setProperty('--dur', (900 + Math.floor(Math.random() * 700)) + 'ms');
                c.style.transform = `translateY(0) rotate(${Math.floor(Math.random() * 360)}deg)`;
                // stagger delay
                c.style.animationDelay = (Math.random() * 220) + 'ms';
                overlay.appendChild(c);
                created.push(c);
            }

            // duration for the whole overlay (slightly longer than confetti animation)
            const totalMs = 1600;
            setTimeout(() => {
                // clean confetti
                created.forEach(el => el.remove());
                overlay.classList.remove('show');
                // small delay to allow fade-out
                setTimeout(() => {
                    if (typeof cb === 'function') cb();
                }, 260);
            }, totalMs);
        }

        // --- Quest completion animation (NEW) ---
        // When user finishes a quest via the "Start" flow (fullscreen active quest),
        // show a full-screen celebratory animation, then call completeQuest (quietly)
        function showQuestCompleteAnimation(questId, cb) {
            const overlay = document.getElementById('quest-complete-overlay');
            if (!overlay) {
                // fallback: just complete and callback
                completeQuest(questId);
                if (typeof cb === 'function') cb();
                return;
            }

            // ensure phrases stopped
            stopInspirationalPhrases();

            // create card content
            overlay.innerHTML = ''; // clear
            overlay.classList.add('show');
            overlay.setAttribute('aria-hidden', 'false');

            const card = document.createElement('div');
            card.className = 'qc-card';
            const title = document.createElement('div');
            title.className = 'qc-title';
            title.textContent = 'Quest Completed!';
            const sub = document.createElement('div');
            sub.className = 'qc-sub';
            sub.textContent = 'Great job ‚Äî rewards incoming.';
            const coinsBox = document.createElement('div');
            coinsBox.className = 'qc-coins';
            coinsBox.innerHTML = `<div class="qc-coin">+<span id="qc-coin-amount">0</span> üí∞</div>`;

            card.appendChild(title);
            card.appendChild(sub);
            card.appendChild(coinsBox);
            overlay.appendChild(card);

            // small confetti burst
            const colors = ['#ffd700', '#ff6b6b', '#6bf0c4', '#8e9bff', '#ffd9a8'];
            const pieces = 18;
            const created = [];
            for (let i = 0; i < pieces; i++) {
                const c = document.createElement('div');
                c.className = 'qc-confetti';
                const left = Math.random() * 80 + 10; // 10% - 90%
                c.style.left = left + '%';
                c.style.background = colors[Math.floor(Math.random() * colors.length)];
                c.style.animationDelay = (Math.random() * 240) + 'ms';
                overlay.appendChild(c);
                created.push(c);
            }

            // Suppress the small inline celebration in completeQuest while we run our animation
            window.QUIET_COMPLETE = true;

            // call completeQuest immediately so coins and streaks update (but its celebration is suppressed)
            const coinsEarned = completeQuest(questId);

            // update number in overlay
            const qcAmount = document.getElementById('qc-coin-amount');
            if (qcAmount) qcAmount.textContent = coinsEarned;

            // animation duration
            const totalMs = 1600;
            // after animation, clean up & callback
            setTimeout(() => {
                // remove confetti pieces
                created.forEach(el => el.remove());
                overlay.classList.remove('show');
                overlay.setAttribute('aria-hidden', 'true');
                // small delay to allow fade-out
                setTimeout(() => {
                    // restore celebration behavior
                    window.QUIET_COMPLETE = false;
                    overlay.innerHTML = '';
                    if (typeof cb === 'function') cb();
                }, 260);
            }, totalMs);
        }
        window.showQuestCompleteAnimation = showQuestCompleteAnimation;

        // Initialize UI on page load
        document.addEventListener('DOMContentLoaded', function () {
            updateCoins(); updateProfile(); updateStreakUI(); applyBackground(equippedBackground);
            // Preload quests when logged-in; initial state hides main content
        });
    </script>

</body>

</html>
